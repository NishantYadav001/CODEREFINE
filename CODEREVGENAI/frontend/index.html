<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Refine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <!-- Mermaid JS for Flowcharts -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <!-- IDB for IndexedDB Persistence -->
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js"></script>
    <!-- Prettier for Code Formatting -->
    <script src="https://cdn.jsdelivr.net/npm/prettier@3.2.5/standalone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@3.2.5/plugins/estree.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@3.2.5/plugins/babel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@3.2.5/plugins/html.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@3.2.5/plugins/postcss.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@3.2.5/plugins/yaml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@3.2.5/plugins/markdown.js"></script>
    <!-- Monaco Editor Loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <!-- Diff View Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/diff2html/3.4.22/diff2html.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff2html/3.4.22/diff2html-ui.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border-color: #334155;
            --accent-color: #0ea5e9;
        }

        body.light-mode {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #334155;
            --border-color: #cbd5e1;
            --accent-color: #0284c7;
        }

        /* MASTER THEME OVERRIDE - Forces all color classes to use CSS variables */
        .bg-slate-900 { background-color: var(--bg-primary) !important; }
        .bg-slate-800 { background-color: var(--bg-secondary) !important; }
        .bg-slate-700 { background-color: var(--bg-tertiary) !important; }
        .bg-slate-600 { background-color: var(--bg-tertiary) !important; }

        .text-slate-50 { color: var(--text-primary) !important; }
        .text-slate-300 { color: var(--text-secondary) !important; }
        .text-slate-400 { color: var(--text-secondary) !important; }
        .text-slate-500 { color: var(--text-secondary) !important; }

        .border-slate-700, .border-slate-600 { border-color: var(--border-color) !important; }

        * { color: inherit; }
        body { background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        nav { background-color: var(--bg-secondary) !important; color: var(--text-primary) !important; border-bottom-color: var(--border-color) !important; }
        .container { color: var(--text-primary); background-color: transparent; }
        h1, h2, h3, h4, h5, h6 { color: var(--text-primary) !important; }

        /* Form Elements */
        input, textarea, select { background-color: var(--bg-secondary) !important; color: var(--text-primary) !important; border-color: var(--border-color) !important; }
        input::placeholder, textarea::placeholder { color: var(--text-secondary) !important; }
        input:focus, textarea:focus, select:focus { border-color: var(--accent-color) !important; }

        /* Code Elements */
        .code-editor { font-family: 'Fira Code', monospace; background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .code-output { background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); overflow-x: auto; }

        /* Buttons */
        .btn-primary { background: linear-gradient(to right, #2563eb, #9333ea); transition: all 0.3s; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .mode-tab { cursor: pointer; transition: all 0.2s; }
        .mode-tab.active { font-weight: bold; }

        /* Panels */
        .analysis-mode, .generation-mode { transition: opacity 0.3s ease-in-out; }
        .hidden { display: none; }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
        }

        .toast {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
            pointer-events: auto;
        }

        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.info { border-left: 4px solid var(--accent-color); }
        .toast.warning { border-left: 4px solid #f59e0b; }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            to { transform: translateX(400px); opacity: 0; }
        }

        .toast.removing { animation: slideOut 0.3s ease-in forwards; }

        /* Drag & Drop */
        .drag-over { background-color: var(--accent-color) !important; opacity: 0.5; border-color: var(--accent-color) !important; }

        /* Search Results Highlight */
        .search-highlight { background-color: rgba(34, 197, 94, 0.3); border-left: 3px solid #22c55e; }

        .prose pre { background: transparent !important; padding: 0 !important; }

        /* Skeleton Loader */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 0.5rem;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Terminal Output */
        .terminal-window {
            font-family: 'Fira Code', monospace;
            background-color: #0f172a; /* Slate 900 */
            border: 1px solid #334155;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { bg: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Mobile View Utilities */
        .mobile-hidden { display: none !important; }
        @media (min-width: 1024px) {
            .mobile-hidden { display: block !important; }
        }

        /* File Tree Styles */
        #fileSidebar { transition: width 0.3s ease, padding 0.3s ease; }
        .file-tree-item { cursor: pointer; padding: 4px 8px; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 13px; color: #cbd5e1; }
        .file-tree-item:hover { background-color: #334155; color: #fff; }
        .file-tree-item.active { background-color: #0ea5e9; color: #fff; }
        .folder-content { padding-left: 16px; border-left: 1px solid #334155; margin-left: 7px; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-slate-900 text-slate-50 h-screen flex flex-col overflow-hidden">
    <!-- Toast Container -->
    <div id="toast-container"></div>

    <nav class="bg-slate-800 p-4 border-b border-slate-700 shadow-xl flex-none z-20">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div>
                    <h1 id="platform-title" class="text-xl font-bold text-sky-400 leading-none"><i class="fas fa-code-branch mr-2"></i>Code Refine</h1>
                    <p id="platform-subtitle" class="text-xs text-slate-400 mt-1 uppercase tracking-widest font-semibold">Developer Edition</p>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <div id="student-tracking" class="hidden flex items-center gap-3 bg-slate-700/50 px-4 py-1.5 rounded-lg border border-slate-600">
                    <span class="text-[10px] text-slate-400 uppercase font-bold">Total Reviews:</span>
                    <span id="review-count" class="text-sky-400 font-bold">0</span>
                </div>
                <input type="text" id="search-results" placeholder="Search results..." class="hidden px-3 py-1.5 bg-slate-700 border border-slate-600 rounded-lg text-sm text-slate-300 outline-none focus:border-sky-500 w-40">
                <button id="theme-toggle" title="Toggle dark/light mode" class="p-2 rounded-lg hover:bg-slate-700 transition-colors">
                    <i class="fas fa-moon text-yellow-400"></i>
                </button>
                <button id="settings-btn" title="Editor Settings" class="p-2 rounded-lg hover:bg-slate-700 transition-colors">
                    <i class="fas fa-cog text-slate-400"></i>
                </button>
                <button id="shortcuts-btn" title="Keyboard Shortcuts" class="p-2 rounded-lg hover:bg-slate-700 transition-colors">
                    <i class="fas fa-keyboard text-slate-400"></i>
                </button>
                <span id="user-badge" class="px-3 py-1 rounded-full bg-slate-700 text-xs font-bold border border-slate-600">Standard</span>
                <button onclick="logout()" class="text-slate-400 hover:text-white transition-colors" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <!-- Main Layout: Sidebar + Content -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Main Workspace -->
        <main class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-900 relative scroll-smooth">
            <div class="container mx-auto max-w-7xl">
        <!-- Mobile Tab Navigation -->
        <div class="lg:hidden flex mb-4 bg-slate-800 rounded-xl p-1 border border-slate-700">
            <button id="mobile-tab-editor" class="flex-1 py-2 text-xs font-bold rounded-lg bg-sky-600 text-white shadow-sm transition-all">Editor</button>
            <button id="mobile-tab-output" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all">Output</button>
            <button id="mobile-tab-chat" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all">Chat</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 relative">
            <!-- Left Panel (Editor) -->
            <div id="left-panel" class="space-y-4 transition-all">
                
                <div class="grid grid-cols-1 gap-4">
                    <div id="policy-upload-zone" class="hidden bg-slate-800 p-3 rounded-xl border border-dashed border-sky-500/40">
                        <label class="text-[10px] font-bold text-sky-400 block mb-2 uppercase italic"><i class="fas fa-file-shield mr-1"></i> Upload Company Policy</label>
                        <input type="file" id="policyFile" accept=".txt,.pdf" class="text-[10px] text-slate-500 file:mr-3 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-sky-500/10 file:text-sky-400 cursor-pointer">
                    </div>
                </div>

                <!-- Tab Selection -->
                <div class="flex gap-2 mb-4 flex-wrap">
                    <button id="modeAnalysis" class="mode-tab active px-4 py-2 rounded-lg font-bold text-sm border transition-all bg-sky-600 border-sky-600 text-white">
                        <i class="fas fa-microscope mr-2"></i>Analyze Code
                    </button>
                    <button id="modeGenerate" class="mode-tab px-4 py-2 rounded-lg font-bold text-sm border transition-all bg-slate-700 border-slate-700 text-slate-300 hover:bg-slate-600">
                        <i class="fas fa-sparkles mr-2"></i>Generate Code
                    </button>
                </div>

                <!-- Analysis Mode -->
                <div id="analysis-panel" class="analysis-mode space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="text-sm font-bold text-slate-400 uppercase tracking-wider">Workspace</div>
                        <span id="detectedLangDisplay" class="text-xs text-sky-400 font-mono hidden"></span>
                    </div>

                    <!-- Tools & Config Bar -->
                    <div class="grid grid-cols-1 gap-3">
                        <div class="bg-slate-800 p-2 rounded-xl border border-slate-700 flex items-center gap-2">
                            <div class="flex-1">
                                <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1 block">Import Source</label>
                                <div class="flex gap-2">
                                    <label class="cursor-pointer bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs px-3 py-1.5 rounded-lg border border-slate-600 flex items-center gap-2 transition-all shadow-sm">
                                        <i class="fas fa-folder-open text-yellow-400"></i> <span class="hidden sm:inline">Open File</span>
                                        <input type="file" id="localFile" class="hidden">
                                    </label>
                                    <label class="cursor-pointer bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs px-3 py-1.5 rounded-lg border border-slate-600 flex items-center gap-2 transition-all shadow-sm">
                                        <i class="fas fa-camera text-sky-400"></i> <span class="hidden sm:inline">Scan Image</span>
                                        <input type="file" id="ocrFile" accept="image/*" class="hidden">
                                    </label>
                                    <div class="flex-1 flex gap-1">
                                        <input type="text" id="githubUrl" placeholder="GitHub / Raw URL..." class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-1.5 text-xs text-slate-300 outline-none focus:border-sky-500">
                                        <button id="loadGithubBtn" class="bg-slate-700 hover:bg-sky-600 text-white px-3 rounded-lg border border-slate-600 transition-colors"><i class="fas fa-arrow-right"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Editor Container -->
                    <div id="editorWrapper" class="border border-slate-700 rounded-xl overflow-hidden bg-slate-900 shadow-lg group">
                        <div class="bg-slate-800 px-4 py-2 flex items-center justify-between border-b border-slate-700">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-code text-slate-400 text-sm"></i>
                                <span class="text-xs font-bold text-slate-300">Code Editor</span>
                            </div>
                            <div class="flex gap-1 flex-wrap justify-end">
                                <!-- Analysis Buttons -->
                                <button id="reviewBtn" class="px-2 py-1 text-xs font-bold text-sky-400 hover:text-white hover:bg-sky-600 rounded transition-colors mr-1" title="Run Review (Ctrl+Enter)"><i class="fas fa-microscope mr-1"></i> Review</button>
                                <button id="fixBtn" class="px-2 py-1 text-xs font-bold text-yellow-400 hover:text-white hover:bg-yellow-600 rounded transition-colors mr-1" title="Auto-Rewrite"><i class="fas fa-wand-magic-sparkles mr-1"></i> Fix</button>
                                
                                <!-- Shared Buttons -->
                                <button id="runCodeBtn" class="px-2 py-1 text-xs font-bold text-emerald-400 hover:text-white hover:bg-emerald-600 rounded transition-colors mr-1" title="Run Code"><i class="fas fa-play mr-1"></i> Run</button>
                                <button id="visualizeBtn" class="px-2 py-1 text-xs font-bold text-purple-400 hover:text-white hover:bg-purple-600 rounded transition-colors mr-2" title="Visualize Logic"><i class="fas fa-project-diagram mr-1"></i> Viz</button>
                                <div class="w-px h-4 bg-slate-700 mx-1 self-center hidden sm:block"></div>
                                <button id="formatBtn" class="px-2 py-1 text-xs font-medium text-slate-400 hover:text-white hover:bg-slate-700 rounded transition-colors" title="Format Code"><i class="fas fa-align-left mr-1"></i> Format</button>
                                <button id="minifyBtn" class="px-2 py-1 text-xs font-medium text-slate-400 hover:text-white hover:bg-slate-700 rounded transition-colors" title="Minify Code"><i class="fas fa-compress-arrows-alt mr-1"></i> Minify</button>
                                <button id="wordWrapBtn" class="px-2 py-1 text-xs font-medium text-slate-400 hover:text-white hover:bg-slate-700 rounded transition-colors" title="Toggle Word Wrap"><i class="fas fa-paragraph"></i></button>
                                <button id="voiceCodeBtn" class="px-2 py-1 text-xs font-medium text-slate-400 hover:text-white hover:bg-slate-700 rounded transition-colors" title="Voice Command"><i class="fas fa-microphone"></i></button>
                                <button id="clearEditorBtn" class="px-2 py-1 text-xs font-medium text-red-400 hover:text-white hover:bg-red-900/50 rounded transition-colors" title="Clear Editor"><i class="fas fa-trash"></i></button>
                                <button id="fullscreenBtn" class="px-2 py-1 text-xs font-medium text-slate-400 hover:text-white hover:bg-slate-700 rounded transition-colors" title="Toggle Fullscreen"><i class="fas fa-expand"></i></button>
                            </div>
                        </div>
                        <div id="monaco-container" class="w-full h-[400px] dropzone"></div>
                        <div class="bg-slate-800 px-4 py-2 border-t border-slate-700 flex items-center justify-between gap-3 flex-wrap">
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold text-slate-500 uppercase"><i class="fas fa-crosshairs text-sky-400 mr-1"></i>Focus:</span>
                                <label class="flex items-center cursor-pointer text-xs text-slate-300 hover:text-white"><input type="checkbox" name="focusArea" value="Bugs" checked class="mr-1.5 accent-sky-500 rounded">Bugs</label>
                                <label class="flex items-center cursor-pointer text-xs text-slate-300 hover:text-white"><input type="checkbox" name="focusArea" value="Performance" checked class="mr-1.5 accent-sky-500 rounded">Performance</label>
                                <label class="flex items-center cursor-pointer text-xs text-slate-300 hover:text-white"><input type="checkbox" name="focusArea" value="Security" checked class="mr-1.5 accent-sky-500 rounded">Security</label>
                                <label class="flex items-center cursor-pointer text-xs text-slate-300 hover:text-white"><input type="checkbox" name="focusArea" value="Best Practices" checked class="mr-1.5 accent-sky-500 rounded">Best Practices</label>
                            </div>
                            <div class="flex items-center gap-3">
                                <span id="cursorStatus" class="text-[10px] font-mono text-slate-500">Ln 1, Col 1</span>
                                <select id="editorLang" class="bg-slate-900 border border-slate-600 rounded-lg p-1 text-xs outline-none focus:border-sky-500 text-slate-300 w-24">
                                    <option value="python">Python</option><option value="javascript">JavaScript</option><option value="typescript">TypeScript</option><option value="java">Java</option><option value="cpp">C++</option><option value="csharp">C#</option><option value="go">Go</option><option value="rust">Rust</option><option value="html">HTML</option><option value="css">CSS</option><option value="json">JSON</option><option value="sql">SQL</option>
                                </select>
                                <div class="w-px h-3 bg-slate-700"></div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase"><i class="fas fa-brain text-purple-400 mr-1"></i>Model:</label>
                                <select id="modelSelectorAnalysis" class="bg-slate-900 border border-slate-600 rounded-lg p-1 text-xs outline-none focus:border-sky-500 text-slate-300 w-40">
                                    <option value="llama-3.3-70b">ü¶ô Llama 3.3 70B</option>
                                    <option value="llama-3.1-405b">ü¶ô Llama 3.1 405B</option>
                                    <option value="mixtral-8x7b-32768">üéØ Mixtral 8x7B</option>
                                    <option value="gemini-pro">‚ú® Gemini Pro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Execution & Visualization Output -->
                    <div id="toolsOutputSection" class="hidden space-y-4">
                        <div id="terminalContainer" class="hidden">
                            <h3 class="text-xs font-bold text-emerald-400 uppercase mb-2"><i class="fas fa-terminal mr-2"></i>Terminal Output</h3>
                            <pre id="terminalOutput" class="terminal-window p-4 rounded-xl text-sm text-slate-300 overflow-x-auto min-h-[100px] max-h-[300px] whitespace-pre-wrap">Ready to execute...</pre>
                        </div>
                        <div id="visualizerContainer" class="hidden">
                            <h3 class="text-xs font-bold text-purple-400 uppercase mb-2"><i class="fas fa-sitemap mr-2"></i>Logic Flowchart</h3>
                            <div id="mermaidOutput" class="bg-white/5 p-4 rounded-xl overflow-x-auto flex justify-center min-h-[200px]"></div>
                        </div>
                    </div>
                </div>

            <!-- Right Panel (Output/Chat) -->
            <div id="right-panel" class="flex flex-col mobile-hidden lg:block">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex gap-2 bg-slate-800/50 p-1 rounded-lg border border-slate-700">
                        <button id="tabResults" class="px-4 py-1.5 rounded-md text-xs font-bold bg-slate-600 text-white shadow-sm transition-all">
                            <i class="fas fa-chart-pie mr-2"></i>Results
                        </button>
                        <button id="tabChat" class="px-4 py-1.5 rounded-md text-xs font-bold text-slate-400 hover:text-white hover:bg-slate-700/50 transition-all">
                            <i class="fas fa-comments mr-2"></i>AI Chat
                        </button>
                    </div>
                    <div id="plagiarism-badge" class="hidden px-3 py-1 bg-orange-900/40 border border-orange-700 rounded-lg ml-auto">
                        <span class="text-[10px] text-orange-300 font-bold uppercase">Similarity: </span>
                        <span id="plag-score" class="text-xs font-bold text-white">0%</span>
                    </div>
                </div>
                
                <div id="reviewResults" class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg flex-grow overflow-y-auto max-h-[550px]">
                    <div class="grid grid-cols-4 gap-3 text-center mb-6">
                        <div class="p-2 bg-red-900/40 border border-red-700/50 rounded-xl">
                            <p id="critical-count" class="font-bold text-2xl text-red-400">0</p>
                            <p class="text-[10px] uppercase font-bold text-red-300">Critical</p>
                        </div>
                        <div class="p-2 bg-orange-900/40 border border-orange-700/50 rounded-xl">
                            <p id="high-count" class="font-bold text-2xl text-orange-400">0</p>
                            <p class="text-[10px] uppercase font-bold text-orange-300">High</p>
                        </div>
                        <div class="p-2 bg-yellow-900/40 border border-yellow-700/50 rounded-xl">
                            <p id="medium-count" class="font-bold text-2xl text-yellow-400">0</p>
                            <p class="text-[10px] uppercase font-bold text-yellow-300">Medium</p>
                        </div>
                        <div class="p-2 bg-blue-900/40 border border-blue-700/50 rounded-xl">
                             <p id="low-count" class="font-bold text-2xl text-blue-400">0</p>
                             <p class="text-[10px] uppercase font-bold text-blue-300">Low</p>
                        </div>
                    </div>
                    <div id="reviewFeedback" class="prose prose-invert max-w-none text-slate-300">
                        <p class="italic text-slate-500">Run a review to see AI insights...</p>
                    </div>
                </div>

                <!-- Chat Interface -->
                <div id="chatInterface" class="hidden bg-slate-800 p-4 rounded-2xl border border-slate-700 shadow-2xl flex-grow flex flex-col h-[550px]">
                    <div class="flex justify-end mb-2">
                        <button id="clearChatBtn" class="text-[10px] uppercase font-bold text-slate-500 hover:text-red-400 transition-colors flex items-center gap-1">
                            <i class="fas fa-trash-alt"></i> Clear Chat
                        </button>
                    </div>
                    <div id="chatHistory" class="flex-grow overflow-y-auto space-y-4 mb-4 pr-2">
                        <div class="flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-robot text-white text-xs"></i></div>
                            <div class="bg-slate-700/50 p-3 rounded-2xl rounded-tl-none text-sm text-slate-300 border border-slate-600">
                                Hello! I'm ready to answer questions about your code.
                            </div>
                        </div>
                    </div>
                    <div class="relative">
                        <input type="text" id="chatInput" placeholder="Ask a question about the code..." 
                            class="w-full bg-slate-900/50 border border-slate-600 rounded-xl py-3 pl-4 pr-12 text-sm text-slate-200 outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all">
                        <button id="sendChatBtn" class="absolute right-2 top-2 p-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg transition-all">
                            <i class="fas fa-paper-plane text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-12 bg-slate-800/30 p-6 rounded-3xl border border-slate-800">
            <h2 class="text-xl font-bold mb-6 text-center text-slate-400 uppercase tracking-widest">Code Transformation & Analysis</h2>
            
            <div id="complexity-section" class="hidden mb-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-slate-700/50 p-5 rounded-2xl border border-orange-700/30">
                    <h3 class="text-sm font-bold text-orange-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                        <i class="fas fa-clock"></i> Original Code Complexity
                    </h3>
                    <div class="flex items-center gap-3">
                        <div class="text-4xl font-black text-orange-400" id="original-complexity-display">O(n)</div>
                        <p class="text-xs text-slate-400">Time complexity of the original code</p>
                    </div>
                </div>
                
                <div class="bg-slate-700/50 p-5 rounded-2xl border border-green-700/30">
                    <h3 class="text-sm font-bold text-green-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                        <i class="fas fa-rocket"></i> Optimized Code Complexity
                    </h3>
                    <div class="flex items-center gap-3">
                        <div class="text-4xl font-black text-green-400" id="rewritten-complexity-display">O(n)</div>
                        <p class="text-xs text-slate-400">Time complexity of the rewritten code</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-end mb-2">
                <button id="toggleDiffBtn" class="hidden text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded border border-slate-600 text-slate-300"><i class="fas fa-columns mr-1"></i> Toggle Diff View</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="codeDisplaySection">
                <div id="originalCodeSection" class="flex flex-col h-full">
                    <div class="bg-slate-800 rounded-t-xl border border-slate-700 border-b-0 p-3 flex items-center justify-between">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider pl-2">Original Input</span>
                        <div class="flex gap-1.5">
                            <div class="w-2.5 h-2.5 rounded-full bg-red-500/50"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/50"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-green-500/50"></div>
                        </div>
                    </div>
                    <pre class="code-output rounded-b-xl border border-slate-700 p-4 min-h-[300px] flex-1 text-sm"><code id="originalCodeOutput" class="language-python"></code></pre>
                </div>
                <div class="relative flex flex-col h-full" id="generatedCodeSection">
                     <div class="bg-slate-800 rounded-t-xl border border-slate-700 border-b-0 p-3 flex items-center justify-between">
                        <span class="text-xs font-bold text-sky-400 uppercase tracking-wider pl-2 flex items-center gap-2"><i class="fas fa-wand-magic-sparkles"></i> AI Rewritten</span>
                        <div class="flex gap-2">
                             <button id="copyBtn" class="text-slate-400 hover:text-white transition-colors px-2" title="Copy Code"><i class="fas fa-copy"></i></button>
                             <button id="downloadCodeBtn" class="hidden text-slate-400 hover:text-white transition-colors px-2" title="Download Code"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                     <pre class="code-output rounded-b-xl border border-slate-700 border-sky-500/30 p-4 min-h-[300px] flex-1 text-sm relative"><code id="rewrittenCodeOutput" class="language-python"></code></pre>
                </div>
            </div>

            <!-- Diff View Container -->
            <div id="diffViewContainer" class="hidden bg-white rounded-xl overflow-hidden p-1"></div>

            <!-- Generation Mode Placeholder -->
            <div id="generationPlaceholder" class="hidden mt-8">
                <div class="bg-gradient-to-br from-emerald-900/20 to-teal-900/20 border border-emerald-700/40 rounded-3xl p-12 text-center">
                    <div class="text-6xl mb-4"><i class="fas fa-magic text-emerald-400"></i></div>
                    <h3 class="text-2xl font-bold text-emerald-300 mb-2">Ready to Generate Code</h3>
                    <p class="text-slate-400">Enter your prompt above and click "Generate Code" to create your custom code</p>
                </div>
            </div>

            <!-- Advanced Features Section -->
            <div id="advanced-features" class="hidden mt-8 pt-8 border-t border-slate-700">
                <h3 class="text-lg font-bold mb-4 text-slate-400 uppercase tracking-wide flex items-center gap-2">
                    <i class="fas fa-flask-vial"></i> Advanced Tools
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <button id="generateTestsBtn" class="bg-slate-700/40 hover:bg-slate-600/50 border border-slate-600/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                        <i class="fas fa-flask"></i>
                        <div class="text-left">
                            <div>Generate Tests</div>
                            <div class="text-[10px] text-slate-400 font-normal">Unit test code</div>
                        </div>
                    </button>
                    
                    <button id="generateDocsBtn" class="bg-slate-700/40 hover:bg-slate-600/50 border border-slate-600/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                        <i class="fas fa-book"></i>
                        <div class="text-left">
                            <div>Generate Docs</div>
                            <div class="text-[10px] text-slate-400 font-normal">Documentation & comments</div>
                        </div>
                    </button>
                    
                    <button id="securityScanBtn" class="bg-slate-700/40 hover:bg-slate-600/50 border border-slate-600/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                        <i class="fas fa-shield-alt"></i>
                        <div class="text-left">
                            <div>Security Scan</div>
                            <div class="text-[10px] text-slate-400 font-normal">Vulnerability check</div>
                        </div>
                    </button>
                    
                    <button id="refactorSuggestionsBtn" class="bg-slate-700/40 hover:bg-slate-600/50 border border-slate-600/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                        <i class="fas fa-hammer"></i>
                        <div class="text-left">
                            <div>Refactor Suggestions</div>
                            <div class="text-[10px] text-slate-400 font-normal">Code improvement tips</div>
                        </div>
                    </button>
                    
                    <button id="saveSnippetBtn" class="bg-slate-700/40 hover:bg-slate-600/50 border border-slate-600/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                        <i class="fas fa-bookmark"></i>
                        <div class="text-left">
                            <div>Save as Snippet</div>
                            <div class="text-[10px] text-slate-400 font-normal">Save for reuse</div>
                        </div>
                    </button>
                    
                    <button id="viewHistoryBtn" class="bg-slate-700/40 hover:bg-slate-600/50 border border-slate-600/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                        <i class="fas fa-history"></i>
                        <div class="text-left">
                            <div>View History</div>
                            <div class="text-[10px] text-slate-400 font-normal">Previous versions</div>
                        </div>
                    </button>
                </div>
            </div>

            <div id="download-section" class="hidden mt-8 pt-8 border-t border-slate-700">
                <h3 class="text-lg font-bold mb-4 text-slate-400 uppercase tracking-wide flex items-center gap-2">
                    <i class="fas fa-file-download"></i> Export & Share
                </h3>
                
                <div class="mb-4 flex items-center gap-3 bg-slate-700/30 p-3 rounded-lg">
                    <span class="text-sm font-bold text-slate-400">Download Format:</span>
                    <div class="flex gap-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="downloadFormat" value="docx" checked class="accent-sky-500">
                            <span class="text-sm text-slate-300">Word (.docx)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="downloadFormat" value="pdf" class="accent-sky-500">
                            <span class="text-sm text-slate-300">PDF (.pdf)</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button id="downloadCodeFileBtn" class="bg-gradient-to-r from-emerald-900/40 to-emerald-800/20 hover:from-emerald-900/60 hover:to-emerald-800/40 border border-emerald-700/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all">
                        <i class="fas fa-code"></i>
                        <div class="text-left">
                            <div>Download Code</div>
                            <div class="text-[10px] text-slate-400 font-normal">Optimized source file</div>
                        </div>
                    </button>
                    <button id="downloadSummaryBtn" class="bg-gradient-to-r from-blue-900/40 to-blue-800/20 hover:from-blue-900/60 hover:to-blue-800/40 border border-blue-700/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all">
                        <i class="fas fa-file-alt"></i>
                        <div class="text-left">
                            <div>Download Summary</div>
                            <div class="text-[10px] text-slate-400 font-normal">Review & analysis</div>
                        </div>
                    </button>
                    <button id="downloadReportBtn" class="bg-gradient-to-r from-purple-900/40 to-purple-800/20 hover:from-purple-900/60 hover:to-purple-800/40 border border-purple-700/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all">
                        <i class="fas fa-file-pdf"></i>
                        <div class="text-left">
                            <div>Download Report</div>
                            <div class="text-[10px] text-slate-400 font-normal">Complete documentation</div>
                        </div>
                    </button>
                </div>
            </div>
            </div>
        </main>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-2xl w-full max-w-md relative transform transition-all scale-100">
            <button id="closeShortcutsBtn" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-keyboard text-sky-400"></i> Keyboard Shortcuts</h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-slate-700/50 rounded-lg border border-slate-600/50">
                    <span class="text-slate-300 text-sm">Run Review</span>
                    <span class="px-2 py-1 bg-slate-600 rounded text-xs font-mono text-white border border-slate-500">Ctrl + Enter</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-slate-700/50 rounded-lg border border-slate-600/50">
                    <span class="text-slate-300 text-sm">Generate Code</span>
                    <span class="px-2 py-1 bg-slate-600 rounded text-xs font-mono text-white border border-slate-500">Ctrl + G</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-slate-700/50 rounded-lg border border-slate-600/50">
                    <span class="text-slate-300 text-sm">Format Code</span>
                    <span class="px-2 py-1 bg-slate-600 rounded text-xs font-mono text-white border border-slate-500">Alt + Shift + F</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white flex items-center gap-2"><i class="fas fa-cog text-slate-400"></i> Editor Settings</h3>
                <button id="closeSettingsBtn" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-300 mb-2">Font Size</label>
                    <input type="range" id="settingFontSize" min="10" max="24" value="14" class="w-full accent-sky-500">
                    <div class="text-right text-xs text-slate-400" id="fontSizeVal">14px</div>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-bold text-slate-300">Minimap</label>
                    <input type="checkbox" id="settingMinimap" class="accent-sky-500 w-5 h-5">
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-bold text-slate-300">Word Wrap</label>
                    <input type="checkbox" id="settingWordWrap" class="accent-sky-500 w-5 h-5">
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-bold text-slate-300">Line Numbers</label>
                    <input type="checkbox" id="settingLineNumbers" checked class="accent-sky-500 w-5 h-5">
                </div>
            </div>
        </div>
    </div>

    <!-- Command Palette -->
    <div id="commandPalette" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-start justify-center pt-20 backdrop-blur-sm">
        <div class="bg-slate-800 w-full max-w-lg rounded-xl border border-slate-700 shadow-2xl overflow-hidden">
            <div class="p-3 border-b border-slate-700 flex items-center gap-3">
                <i class="fas fa-search text-slate-400"></i>
                <input type="text" id="cmdInput" placeholder="Type a command..." class="bg-transparent w-full outline-none text-slate-200 placeholder-slate-500">
                <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-400">ESC</span>
            </div>
            <div id="cmdList" class="max-h-64 overflow-y-auto p-2 space-y-1"></div>
        </div>
    </div>

    <script>
        /**
         * Code Refine - Main Frontend Script
         * Handles UI interactions, API calls, and state management.
         */

        // Global error handler for debugging
        window.onerror = function(msg, url, line, col, error) {
            console.error("‚ùå Global Error:", msg, "\nLine:", line, "\nError:", error);
            return false;
        };

        // Initialize application when DOM is ready
        const initApp = () => {
            // Prevent double initialization
            if (window.appInitialized) return;
            window.appInitialized = true;

            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed', err));
            }

            // Initialize Mermaid
            mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });
            
            // Initialize Monaco Editor
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
            require(['vs/editor/editor.main'], function() {
                const savedCode = localStorage.getItem('codeRefine_content') || "# Paste your code here or drag & drop a file\n# Press Ctrl+Enter to Review\n\ndef hello_world():\n    print('Hello Code Refine!')";
                const savedSettings = JSON.parse(localStorage.getItem('editorSettings')) || { fontSize: 14, minimap: false, wordWrap: 'off', lineNumbers: 'on' };

                window.monacoEditor = monaco.editor.create(document.getElementById('monaco-container'), {
                    value: savedCode,
                    language: "python",
                    theme: "vs-dark",
                    automaticLayout: true,
                    minimap: { enabled: savedSettings.minimap },
                    fontSize: savedSettings.fontSize,
                    wordWrap: savedSettings.wordWrap,
                    lineNumbers: savedSettings.lineNumbers,
                    fontFamily: "'Fira Code', monospace",
                    scrollBeyondLastLine: false,
                    padding: { top: 16, bottom: 16 }
                });

                // Event Listeners for Editor
                window.monacoEditor.onDidChangeCursorPosition((e) => {
                    const status = document.getElementById('cursorStatus');
                    if(status) status.innerText = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
                });

                window.monacoEditor.onDidChangeModelContent(() => {
                    localStorage.setItem('codeRefine_content', window.monacoEditor.getValue());
                });
                
                // Sync Language Selector
                const langSelect = document.getElementById('editorLang');
                if(langSelect) {
                    langSelect.value = 'python'; // Default
                    langSelect.onchange = () => monaco.editor.setModelLanguage(window.monacoEditor.getModel(), langSelect.value);
                }

                // Initialize Settings UI
                get('settingFontSize').value = savedSettings.fontSize;
                get('settingMinimap').checked = savedSettings.minimap;

            });

            // Fetch Piston Runtimes
            fetch('https://emkc.org/api/v2/piston/runtimes').then(r => r.json()).then(data => window.pistonRuntimes = data);

            console.log("üöÄ Code Refine: Initializing...");

            try {
                // --- 1. CONFIGURATION & STATE ---
                const params = new URLSearchParams(window.location.search);
                const userType = params.get('userType') || 'developer';
                const studentName = params.get('email') || params.get('username') || 'Guest';

                // Security Check
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                if (!token && studentName !== 'Guest') {
                    window.location.href = '/login';
                    return;
                }

                const modes = {
                    'student': { title: 'AI DEBUGGER', sub: 'STUDENT Edition', badge: 'Student' },
                    'enterprise': { title: 'Security Shield', sub: 'Enterprise Edition', badge: 'Admin' },
                    'organisation': { title: 'Team Reviewer', sub: 'Organisation Edition', badge: 'Team' },
                    'developer': { title: 'Code Refine', sub: 'Developer Edition', badge: 'Pro' }
                };

                // Safe DOM Element Access Helper
                const get = (id) => document.getElementById(id);
                
                // Robust Event Listener Helper
                const setClick = (id, handler) => {
                    const el = get(id);
                    if (el) {
                        el.addEventListener('click', async (e) => {
                            if (e && e.preventDefault) e.preventDefault();
                            console.log(`üñ±Ô∏è Clicked: ${id}`);
                            try {
                                await handler(e);
                            } catch (err) {
                                console.error(`Error in ${id} handler:`, err);
                                showToast(`Error: ${err.message}`, 'error');
                            }
                        });
                    } else {
                        console.warn(`‚ö†Ô∏è Element with id '${id}' not found.`);
                    }
                };

                const setChange = (id, handler) => {
                    const el = get(id);
                    if (el) {
                        el.addEventListener('change', async (e) => {
                            console.log(`üîÑ Changed: ${id}`);
                            try {
                                await handler(e);
                            } catch (err) {
                                console.error(`Error in ${id} handler:`, err);
                            }
                        });
                    }
                };

                // --- 2. UI SETUP ---
                const config = modes[userType] || modes.developer;
                // if (get('platform-title')) get('platform-title').innerText = config.title; // Keep new logo
                if (get('platform-subtitle')) get('platform-subtitle').innerText = config.sub;
                if (get('user-badge')) get('user-badge').innerText = config.badge;

                if (userType === 'student') {
                    if (get('student-tracking')) get('student-tracking').classList.remove('hidden');
                    if (get('plagiarism-badge')) get('plagiarism-badge').classList.remove('hidden');
                }
                if ((userType === 'enterprise' || userType === 'organisation') && get('policy-upload-zone')) {
                    get('policy-upload-zone').classList.remove('hidden');
                }

                // --- 3. CORE FUNCTIONS ---

                // Toast Notification Helper
                const showToast = (message, type = 'info', duration = 3000) => {
                    const container = get('toast-container');
                    if (!container) return;
                    
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i><span>${message}</span>`;
                    container.appendChild(toast);
                    
                    // Animation
                    setTimeout(() => {
                        toast.classList.add('removing');
                        setTimeout(() => toast.remove(), 300);
                    }, duration);
                };

                // Process Code (Review or Rewrite)
                async function processCode(action) {
                    // Get code from Monaco
                    const code = window.monacoEditor ? window.monacoEditor.getValue() : "";
                    
                    if (!code.trim()) {
                        showToast("Please paste some code first!", "warning");
                        return;
                    }

                    const focusAreas = Array.from(document.querySelectorAll('input[name="focusArea"]:checked')).map(cb => cb.value);
                    
                    // Auto-detect language
                    let language = 'python';
                    if (typeof hljs !== 'undefined') {
                        try {
                            const detected = hljs.highlightAuto(code);
                            language = detected.language || 'python';
                        } catch (e) { console.warn("HighlightJS error", e); }
                    }
                    
                    // Map common aliases
                    const aliasMap = { 'js': 'javascript', 'ts': 'typescript', 'c++': 'cpp', 'cs': 'csharp', 'py': 'python' };
                    language = aliasMap[language] || language;

                    const langDisplay = get('detectedLangDisplay');
                    if (langDisplay) { 
                        langDisplay.textContent = `(Detected: ${language})`; 
                        langDisplay.classList.remove('hidden'); 
                    }
                    
                    // UI Updates for Processing State
                    const originalSection = get('originalCodeSection');
                    const codeDisplaySection = get('codeDisplaySection');
                    const generatedSection = get('generatedCodeSection');
                    const originalOutput = get('originalCodeOutput');
                    const feedback = get('reviewFeedback');
                    
                    if (originalSection) originalSection.style.display = 'block';
                    if (codeDisplaySection) {
                        codeDisplaySection.classList.remove('lg:grid-cols-1');
                        codeDisplaySection.classList.add('lg:grid-cols-2');
                        codeDisplaySection.classList.remove('hidden');
                    }
                    if (generatedSection) {
                        const h3 = generatedSection.querySelector('h3');
                        if (h3) h3.innerHTML = '<i class="fas fa-wand-magic-sparkles text-emerald-400 mr-2"></i>AI Rewritten Version';
                    }
                    
                    if (originalOutput) {
                        originalOutput.textContent = code;
                        if (typeof hljs !== 'undefined') hljs.highlightElement(originalOutput);
                    }

                    if (feedback) {
                        feedback.innerHTML = `
                            <div class="space-y-4 p-2">
                                <div class="flex items-center gap-2 text-sky-400 mb-4"><i class="fas fa-spinner fa-spin"></i> <span class="text-sm font-bold">AI is analyzing your code...</span></div>
                                <div class="skeleton h-8 w-3/4"></div>
                                <div class="skeleton h-4 w-full"></div>
                                <div class="skeleton h-4 w-5/6"></div>
                                <div class="skeleton h-32 w-full"></div>
                                <div class="grid grid-cols-2 gap-4"><div class="skeleton h-20"></div><div class="skeleton h-20"></div></div>
                            </div>`;
                    }

                    try {
                        const endpoint = action === 'review' ? 'review' : 'rewrite';
                        const model = get('globalModelSelector') ? get('globalModelSelector').value : 'llama-3.3-70b';
                        const response = await fetch(`http://localhost:8000/api/${endpoint}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                code: code,
                                language: language,
                                user_type: userType,
                                student_name: studentName,
                                focus_areas: focusAreas,
                                model: model
                            })
                        });

                        if (!response.ok) throw new Error("Server Error: " + response.status);
                        const data = await response.json();

                        // Update Stats
                        if (get('critical-count')) get('critical-count').innerText = data.stats?.critical || 0;
                        if (get('high-count')) get('high-count').innerText = data.stats?.high || 0;
                        if (get('medium-count')) get('medium-count').innerText = data.stats?.medium || 0;
                        if (get('low-count')) get('low-count').innerText = data.stats?.low || 0;

                        if (userType === 'student') {
                            if (get('plag-score')) get('plag-score').innerText = data.plagiarism || "0%";
                            if (get('review-count')) get('review-count').innerText = data.student_stats || 0;
                        }

                        if (feedback) feedback.innerHTML = typeof marked !== 'undefined' ? marked.parse(data.review) : data.review;
                        
                        if (action === 'fix') {
                            const rwOut = get('rewrittenCodeOutput');
                            if (rwOut) {
                                rwOut.textContent = data.rewritten_code;
                                if (typeof hljs !== 'undefined') hljs.highlightElement(rwOut);
                            }
                            
                            if (get('complexity-section')) get('complexity-section').classList.remove('hidden');
                            if (get('original-complexity-display')) get('original-complexity-display').innerText = data.time_complexity_original || "O(n)";
                            if (get('rewritten-complexity-display')) get('rewritten-complexity-display').innerText = data.time_complexity_rewritten || "O(n)";
                            
                            if (get('download-section')) get('download-section').classList.remove('hidden');
                            if (get('downloadCodeBtn')) get('downloadCodeBtn').classList.remove('hidden');
                            if (get('toggleDiffBtn')) get('toggleDiffBtn').classList.remove('hidden');

                            // Save data for downloads
                            window.downloadData = {
                                code: data.rewritten_code,
                                review: data.review,
                                language: language,
                                originalCode: code,
                                stats: data.stats,
                                complexity_original: data.time_complexity_original || "O(n)",
                                complexity_rewritten: data.time_complexity_rewritten || "O(n)"
                            };
                        }
                        if (typeof hljs !== 'undefined') hljs.highlightAll();
                        showToast(`‚úÖ ${action === 'review' ? 'Review' : 'Rewrite'} Complete`, 'success');

                    } catch (err) {
                        if (feedback) feedback.innerHTML = `<p class="text-red-400">Error: ${err.message}</p>`;
                        showToast("Operation failed: " + err.message, "error");
                    }
                }

                // --- NEW FEATURES: RUN & VISUALIZE ---

                async function runCode() {
                    const code = window.monacoEditor ? window.monacoEditor.getValue() : "";
                    if (!code.trim()) return showToast("No code to run!", "warning");

                    const terminalContainer = get('terminalContainer');
                    const terminalOutput = get('terminalOutput');
                    const toolsSection = get('toolsOutputSection');
                    
                    if(toolsSection) toolsSection.classList.remove('hidden');
                    if(terminalContainer) terminalContainer.classList.remove('hidden');
                    if(get('visualizerContainer')) get('visualizerContainer').classList.add('hidden');
                    
                    // Scroll to output
                    setTimeout(() => terminalContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);

                    terminalOutput.innerHTML = '<span class="animate-pulse text-yellow-400">‚è≥ Compiling and executing...</span>';

                    // Map Monaco language to Piston language
                    // Monaco: python, javascript, java, cpp, csharp, go, rust, typescript
                    // Piston needs specific version. We find the first match.
                    let lang = 'python';
                    if (window.monacoEditor) {
                        const modelLang = window.monacoEditor.getModel().getLanguageId();
                        const monacoToPiston = {
                            'python': 'python', 'javascript': 'javascript', 'typescript': 'typescript',
                            'java': 'java', 'cpp': 'c++', 'c': 'c', 'csharp': 'csharp',
                            'go': 'go', 'rust': 'rust', 'php': 'php', 'ruby': 'ruby'
                        };
                        lang = monacoToPiston[modelLang] || modelLang;
                    }

                    // Find runtime version
                    const runtime = window.pistonRuntimes ? window.pistonRuntimes.find(r => r.language === lang) : null;
                    const version = runtime ? runtime.version : "*";
                    
                    // Escape HTML helper
                    const escapeHtml = (text) => text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");

                    try {
                        const res = await fetch('https://emkc.org/api/v2/piston/execute', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                language: lang,
                                version: version,
                                files: [{ content: code }]
                            })
                        });
                        const data = await res.json();
                        
                        if (data.run) {
                            let output = data.run.stdout || "";
                            let error = data.run.stderr || "";
                            terminalOutput.innerHTML = "";
                            if (output) terminalOutput.innerHTML += `<span class="text-emerald-300">${escapeHtml(output)}</span>`;
                            if (error) terminalOutput.innerHTML += `<span class="text-red-400">\n${escapeHtml(error)}</span>`;
                            if (!output && !error) terminalOutput.innerHTML = `<span class="text-slate-500 italic">Program executed successfully with no output.</span>`;
                        } else {
                            terminalOutput.innerHTML = `<span class="text-red-400">Execution failed: ${data.message || "Unknown error"}</span>`;
                        }
                    } catch (e) {
                        terminalOutput.innerHTML = `<span class="text-red-400">API Error: ${e.message}</span>`;
                    }
                }

                async function formatCode() {
                    if (!window.monacoEditor) return;
                    const code = window.monacoEditor.getValue();
                    const lang = window.monacoEditor.getModel().getLanguageId();

                    try {
                        // Fallback to Prettier (Client)
                        let parser = null;
                        if (lang === 'javascript' || lang === 'typescript') parser = 'babel';
                        else if (lang === 'html') parser = 'html';
                        else if (lang === 'css') parser = 'css';
                        else if (lang === 'json') parser = 'json';
                        else if (lang === 'markdown') parser = 'markdown';
                        else if (lang === 'yaml') parser = 'yaml';

                        if (parser && window.prettier && window.prettierPlugins) {
                            formatted = await window.prettier.format(code, {
                                parser: parser,
                                plugins: window.prettierPlugins
                            });
                            window.monacoEditor.setValue(formatted);
                            showToast("Code formatted with Prettier!", "success");
                        } else {
                            // Fallback to Monaco's built-in formatter
                            await window.monacoEditor.getAction('editor.action.formatDocument').run();
                            showToast("Triggered editor formatter", "info");
                        }
                    } catch (e) {
                        showToast("Formatting error: " + e.message, "error");
                    }
                }

                async function minifyCode() {
                    if (!window.monacoEditor) return;
                    const code = window.monacoEditor.getValue();
                    if (!code.trim()) return showToast("No code to minify!", "warning");
                    
                    showToast("Minifying code...", "info");

                    try {
                        const model = get('globalModelSelector') ? get('globalModelSelector').value : 'llama-3.3-70b';
                        const lang = window.monacoEditor.getModel().getLanguageId();
                        
                        const response = await fetch(`http://localhost:8000/api/generate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                prompt: `Minify the following ${lang} code. Remove all unnecessary whitespace, newlines, and comments to make it as compact as possible while preserving functionality. Return ONLY the minified code. Do not use markdown blocks.\n\nCode:\n${code}`,
                                language: lang,
                                user_type: "developer",
                                model: model
                            })
                        });

                        if (!response.ok) throw new Error("Minification failed");
                        const data = await response.json();
                        let minified = data.generated_code || "";
                        
                        // Strip markdown if AI ignores instruction
                        minified = minified.replace(/^```[a-z]*\n?/i, '').replace(/```$/, '').trim();
                        
                        if(minified) {
                            window.monacoEditor.setValue(minified);
                            showToast("Code minified successfully!", "success");
                        } else {
                            showToast("AI returned empty code", "error");
                        }
                    } catch (e) {
                        showToast("Error: " + e.message, "error");
                    }
                }

                async function visualizeCode() {
                    const code = window.monacoEditor ? window.monacoEditor.getValue() : "";
                    if (!code.trim()) return showToast("No code to visualize!", "warning");

                    const vizContainer = get('visualizerContainer');
                    const mermaidOutput = get('mermaidOutput');
                    const toolsSection = get('toolsOutputSection');

                    if(toolsSection) toolsSection.classList.remove('hidden');
                    if(vizContainer) vizContainer.classList.remove('hidden');
                    if(get('terminalContainer')) get('terminalContainer').classList.add('hidden');

                    mermaidOutput.innerHTML = '<div class="animate-pulse text-purple-400"><i class="fas fa-brain fa-spin mr-2"></i>Analyzing logic flow...</div>';

                    // Use the existing generation endpoint to create Mermaid syntax
                    try {
                        const prompt = "Generate a Mermaid.js flowchart (graph TD) representing the logic of this code. Return ONLY the mermaid code inside a markdown block (```mermaid ... ```). Do not explain.";
                        const model = get('globalModelSelector') ? get('globalModelSelector').value : 'llama-3.3-70b';
                        
                        const response = await fetch(`http://localhost:8000/api/generate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                prompt: `${prompt}\n\nCode:\n${code}`,
                                language: "mermaid",
                                user_type: "developer",
                                model: model
                            })
                        });
                        
                        const data = await response.json();
                        let mermaidCode = data.generated_code || "";
                        
                        // Clean up markdown tags if present
                        mermaidCode = mermaidCode.replace(/```mermaid/g, '').replace(/```/g, '').trim();

                        mermaidOutput.innerHTML = '';
                        const { svg } = await mermaid.render('graphDiv', mermaidCode);
                        mermaidOutput.innerHTML = svg;
                        
                    } catch (e) {
                        mermaidOutput.innerHTML = `<p class="text-red-400">Visualization failed: ${e.message}</p>`;
                    }
                }

                // --- CHAT FEATURE ---
                const setupChat = () => {
                    const tabResults = get('tabResults');
                    const tabChat = get('tabChat');
                    const reviewResults = get('reviewResults');
                    const chatInterface = get('chatInterface');
                    const chatInput = get('chatInput');
                    const sendChatBtn = get('sendChatBtn');
                    const chatHistory = get('chatHistory');
                    const clearChatBtn = get('clearChatBtn');

                    if(tabResults && tabChat) {
                        tabResults.onclick = () => {
                            reviewResults.classList.remove('hidden');
                            chatInterface.classList.add('hidden');
                            tabResults.classList.add('bg-slate-600', 'text-white', 'shadow-sm');
                            tabResults.classList.remove('text-slate-400', 'hover:bg-slate-700/50');
                            tabChat.classList.remove('bg-slate-600', 'text-white', 'shadow-sm');
                            tabChat.classList.add('text-slate-400', 'hover:bg-slate-700/50');
                        };
                        tabChat.onclick = () => {
                            reviewResults.classList.add('hidden');
                            chatInterface.classList.remove('hidden');
                            tabChat.classList.add('bg-slate-600', 'text-white', 'shadow-sm');
                            tabChat.classList.remove('text-slate-400', 'hover:bg-slate-700/50');
                            tabResults.classList.remove('bg-slate-600', 'text-white', 'shadow-sm');
                            tabResults.classList.add('text-slate-400', 'hover:bg-slate-700/50');
                        };
                    }

                    const sendMsg = async () => {
                        const msg = chatInput.value.trim();
                        if(!msg) return;

                        // User Message
                        chatHistory.innerHTML += `
                            <div class="flex gap-3 flex-row-reverse">
                                <div class="w-8 h-8 rounded-full bg-sky-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-user text-white text-xs"></i></div>
                                <div class="bg-sky-900/30 p-3 rounded-2xl rounded-tr-none text-sm text-sky-100 border border-sky-700/50">${msg}</div>
                            </div>`;
                        chatInput.value = '';
                        chatHistory.scrollTop = chatHistory.scrollHeight;

                        // AI Loading
                        const loadingId = 'loading-' + Date.now();
                        chatHistory.innerHTML += `
                            <div id="${loadingId}" class="flex gap-3">
                                <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-robot text-white text-xs"></i></div>
                                <div class="bg-slate-700/50 p-3 rounded-2xl rounded-tl-none text-sm text-slate-400 border border-slate-600 animate-pulse">Thinking...</div>
                            </div>`;
                        chatHistory.scrollTop = chatHistory.scrollHeight;

                        try {
                            const code = window.monacoEditor ? window.monacoEditor.getValue() : "";
                            const model = get('globalModelSelector') ? get('globalModelSelector').value : 'llama-3.3-70b';
                            
                            const res = await fetch('http://localhost:8000/api/generate', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    prompt: `Context Code:\n${code}\n\nUser Question: ${msg}\n\nAnswer the question based on the code context. Keep it concise.`,
                                    language: "markdown",
                                    user_type: "developer",
                                    model: model
                                })
                            });
                            const data = await res.json();
                            const aiMsg = data.generated_code || "I couldn't generate a response.";
                            
                            document.getElementById(loadingId).remove();
                            chatHistory.innerHTML += `
                                <div class="flex gap-3">
                                    <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-robot text-white text-xs"></i></div>
                                    <div class="bg-slate-700/50 p-3 rounded-2xl rounded-tl-none text-sm text-slate-300 border border-slate-600 prose prose-invert prose-sm max-w-none">
                                        ${typeof marked !== 'undefined' ? marked.parse(aiMsg) : aiMsg}
                                    </div>
                                </div>`;
                            chatHistory.scrollTop = chatHistory.scrollHeight;
                        } catch(e) {
                            document.getElementById(loadingId).innerHTML = `<div class="text-red-400">Error: ${e.message}</div>`;
                        }
                    };

                    if(clearChatBtn) {
                        clearChatBtn.onclick = () => {
                            chatHistory.innerHTML = `
                                <div class="flex gap-3">
                                    <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center flex-shrink-0"><i class="fas fa-robot text-white text-xs"></i></div>
                                    <div class="bg-slate-700/50 p-3 rounded-2xl rounded-tl-none text-sm text-slate-300 border border-slate-600">
                                        Hello! I'm ready to answer questions about your code.
                                    </div>
                                </div>`;
                            showToast('Chat history cleared', 'info');
                        };
                    }

                    if(sendChatBtn) sendChatBtn.onclick = sendMsg;
                    if(chatInput) chatInput.onkeypress = (e) => { if(e.key === 'Enter') sendMsg(); };
                };
                setupChat();

                // --- 4. EVENT LISTENERS ---

                // OCR
                setChange('ocrFile', async (e) => {
                    if (!e.target.files[0]) return;

                    if (!window.monacoEditor) return;

                    const originalValue = window.monacoEditor.getValue();
                    window.monacoEditor.setValue("# ‚è≥ Scanning image... please wait...");
                    // Monaco doesn't have a simple 'disabled' state like textarea, 
                    // but we can set readOnly if we wanted. For now, just text update.
                    
                    // Switch to Analysis Mode if not already
                    const modeAnalysis = get('modeAnalysis');
                    if (modeAnalysis) modeAnalysis.click();

                    try {
                        // 1. Try Client-Side OCR
                        if (typeof Tesseract !== 'undefined') {
                            const worker = await Tesseract.createWorker('eng');
                            const ret = await worker.recognize(e.target.files[0]);
                            await worker.terminate();
                            
                            if (ret.data.text) {
                                window.monacoEditor.setValue(ret.data.text);
                                showToast('‚úÖ OCR Complete (Client-side)', 'success');
                                return; // Success
                            }
                        }
                        throw new Error("Client OCR skipped or failed");

                    } catch (err) { 
                        console.warn("Client OCR failed, trying backend...", err);
                        // 2. Fallback to Backend
                        const formData = new FormData();
                        formData.append('file', e.target.files[0]);
                        try {
                            const res = await fetch('http://localhost:8000/api/ocr', { method: 'POST', body: formData });
                            if (!res.ok) throw new Error("Backend OCR Failed");
                            const data = await res.json();
                            window.monacoEditor.setValue(data.extracted_code || "// No code detected");
                            showToast('‚úÖ OCR Complete (Server-side)', 'success');
                        } catch (serverErr) {
                            alert("OCR Failed: " + serverErr.message);
                            window.monacoEditor.setValue(originalValue);
                        }
                    } finally {
                        e.target.value = ''; 
                    }
                });

                // GitHub Loader
                setClick('loadGithubBtn', async () => {
                    const urlInput = get('githubUrl');
                    if (!urlInput || !urlInput.value) return showToast("Please enter a URL", "warning");
                    
                    let url = urlInput.value.trim();
                    // Convert github.com blob to raw
                    if (url.includes('github.com') && url.includes('/blob/')) {
                        url = url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
                    }

                    try {
                        showToast("Fetching code...", "info");
                        const res = await fetch(url);
                        if (!res.ok) throw new Error("Failed to fetch");
                        const text = await res.text();
                        if (window.monacoEditor) window.monacoEditor.setValue(text);
                        showToast("Code loaded from URL", "success");
                        urlInput.value = ""; 
                    } catch (e) {
                        showToast("Error loading URL: " + e.message, "error");
                    }
                });

                // Policy Upload
                setChange('policyFile', async (e) => {
                    if (!e.target.files[0]) return;
                    const formData = new FormData();
                    formData.append('file', e.target.files[0]);
                    try {
                        const res = await fetch('http://localhost:8000/api/upload-policy', { method: 'POST', body: formData });
                        const data = await res.json();
                        showToast(data.message, 'success');
                    } catch (err) { showToast("Upload failed", "error"); }
                });

                // Buttons
                setClick('reviewBtn', () => processCode('review'));
                setClick('fixBtn', () => processCode('fix'));
                setClick('runCodeBtn', runCode);
                setClick('visualizeBtn', visualizeCode);
                setClick('formatBtn', formatCode);
                setClick('minifyBtn', minifyCode);
                
                setClick('wordWrapBtn', () => {
                    if(!window.monacoEditor) return;
                    const current = window.monacoEditor.getOption(monaco.editor.EditorOption.wordWrap);
                    const newState = current === 'off' ? 'on' : 'off';
                    window.monacoEditor.updateOptions({ wordWrap: newState });
                    showToast(`Word Wrap: ${newState.toUpperCase()}`, 'info');
                });

                setClick('clearEditorBtn', () => {
                    if(window.monacoEditor && confirm("Clear editor content?")) window.monacoEditor.setValue('');
                });
                
                setClick('fullscreenBtn', () => {
                    const wrapper = document.getElementById('editorWrapper');
                    const container = document.getElementById('monaco-container');
                    
                    if (!document.fullscreenElement) {
                        wrapper.requestFullscreen().catch(err => {
                            showToast(`Error enabling fullscreen: ${err.message}`, 'error');
                        });
                        container.style.height = '100vh';
                    } else {
                        document.exitFullscreen();
                        container.style.height = '400px';
                    }
                });

                document.addEventListener('fullscreenchange', () => {
                    const container = document.getElementById('monaco-container');
                    if (!document.fullscreenElement) {
                        container.style.height = '400px';
                    } else {
                        container.style.height = 'calc(100vh - 80px)'; // Adjust for header/footer
                    }
                    if (window.monacoEditor) window.monacoEditor.layout();
                });

                // Shortcuts Modal
                const modal = get('shortcutsModal');
                setClick('shortcuts-btn', () => modal.classList.remove('hidden'));
                setClick('closeShortcutsBtn', () => modal.classList.add('hidden'));

                // --- SETTINGS MODAL LOGIC ---
                const settingsModal = get('settingsModal');
                setClick('settings-btn', () => settingsModal.classList.remove('hidden'));
                setClick('closeSettingsBtn', () => settingsModal.classList.add('hidden'));

                const updateSettings = () => {
                    if(!window.monacoEditor) return;
                    const fontSize = parseInt(get('settingFontSize').value);
                    const minimap = get('settingMinimap').checked;
                    const wordWrap = get('settingWordWrap').checked ? 'on' : 'off';
                    const lineNumbers = get('settingLineNumbers').checked ? 'on' : 'off';

                    get('fontSizeVal').innerText = fontSize + 'px';
                    
                    window.monacoEditor.updateOptions({
                        fontSize: fontSize,
                        minimap: { enabled: minimap },
                        wordWrap: wordWrap,
                        lineNumbers: lineNumbers
                    });

                    localStorage.setItem('editorSettings', JSON.stringify({ fontSize, minimap, wordWrap, lineNumbers }));
                };

                ['settingFontSize', 'settingMinimap', 'settingWordWrap', 'settingLineNumbers'].forEach(id => {
                    const el = get(id);
                    if(el) el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', updateSettings);
                });

                // --- COMMAND PALETTE LOGIC ---
                const cmdPalette = get('commandPalette');
                const cmdInput = get('cmdInput');
                const cmdList = get('cmdList');

                const commands = [
                    { label: 'Run Review', icon: 'microscope', action: () => get('reviewBtn').click() },
                    { label: 'Generate Code', icon: 'wand-magic-sparkles', action: () => window.location.href = '/generate' },
                    { label: 'Format Code', icon: 'align-left', action: () => formatCode() },
                    { label: 'Minify Code', icon: 'compress-arrows-alt', action: () => minifyCode() },
                    { label: 'Run Code', icon: 'play', action: () => runCode() },
                    { label: 'Visualize Logic', icon: 'project-diagram', action: () => visualizeCode() },
                    { label: 'Toggle Fullscreen', icon: 'expand', action: () => get('fullscreenBtn').click() },
                    { label: 'Clear Editor', icon: 'trash', action: () => get('clearEditorBtn').click() },
                    { label: 'Open Settings', icon: 'cog', action: () => get('settings-btn').click() }
                ];

                const renderCommands = (filter = '') => {
                    cmdList.innerHTML = '';
                    const filtered = commands.filter(c => c.label.toLowerCase().includes(filter.toLowerCase()));
                    filtered.forEach((cmd, idx) => {
                        const div = document.createElement('div');
                        div.className = `p-2 hover:bg-slate-700 rounded cursor-pointer flex items-center gap-3 text-sm text-slate-300 ${idx === 0 ? 'bg-slate-700' : ''}`;
                        div.innerHTML = `<i class="fas fa-${cmd.icon} w-5 text-center"></i> ${cmd.label}`;
                        div.onclick = () => {
                            cmd.action();
                            cmdPalette.classList.add('hidden');
                        };
                        cmdList.appendChild(div);
                    });
                };

                cmdInput.addEventListener('input', (e) => renderCommands(e.target.value));

                // --- MOBILE TABS LOGIC ---
                const leftPanel = get('left-panel');
                const rightPanel = get('right-panel');
                const mTabEditor = get('mobile-tab-editor');
                const mTabOutput = get('mobile-tab-output');
                const mTabChat = get('mobile-tab-chat');

                const setMobileView = (view) => {
                    // Reset Tabs
                    [mTabEditor, mTabOutput, mTabChat].forEach(t => {
                        t.className = "flex-1 py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white transition-all";
                    });

                    if(view === 'editor') {
                        leftPanel.classList.remove('mobile-hidden');
                        rightPanel.classList.add('mobile-hidden');
                        mTabEditor.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-sky-600 text-white shadow-sm transition-all";
                    } else {
                        leftPanel.classList.add('mobile-hidden');
                        rightPanel.classList.remove('mobile-hidden');
                        if(view === 'output') {
                            get('tabResults').click();
                            mTabOutput.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-sky-600 text-white shadow-sm transition-all";
                        } else {
                            get('tabChat').click();
                            mTabChat.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-sky-600 text-white shadow-sm transition-all";
                        }
                    }
                };

                if(mTabEditor) {
                    mTabEditor.onclick = () => setMobileView('editor');
                    mTabOutput.onclick = () => setMobileView('output');
                    mTabChat.onclick = () => setMobileView('chat');
                }

                // --- FILE OPEN LOGIC ---
                setChange('localFile', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const text = await file.text();
                        if (window.monacoEditor) {
                            window.monacoEditor.setValue(text);
                            // Try to detect language from extension
                            const ext = file.name.split('.').pop();
                            const langMap = {'js':'javascript', 'py':'python', 'html':'html', 'css':'css', 'json':'json', 'md':'markdown', 'ts':'typescript', 'java':'java', 'cpp':'cpp', 'c':'c', 'cs':'csharp', 'go':'go', 'rs':'rust', 'sql':'sql'};
                            if(langMap[ext]) monaco.editor.setModelLanguage(window.monacoEditor.getModel(), langMap[ext]);
                        }
                        showToast(`üìÇ Opened: ${file.name}`, 'success');
                    } catch (err) {
                        showToast("Failed to read file", "error");
                    }
                    e.target.value = ''; // Reset
                });

                // Generate Code
                setClick('generateBtn', async () => {
                    const promptInput = get('generationPrompt');
                    if (!promptInput) return;
                    
                    const prompt = promptInput.value.trim();
                    if (!prompt) {
                        showToast("Please describe what code you want to generate!", "warning");
                        return;
                    }

                    const language = get('generationLanguage') ? get('generationLanguage').value : 'python';
                    const style = get('generationStyle') ? get('generationStyle').value : 'production';
                    
                    const feedback = get('reviewFeedback');
                    const model = get('globalModelSelector') ? get('globalModelSelector').value : 'llama-3.3-70b';
                    const framework = get('generationFramework') ? get('generationFramework').value : 'none';
                    
                    // Context Logic
                    const includeContext = get('includeContext') ? get('includeContext').checked : false;
                    let finalPrompt = prompt;
                    if (includeContext && window.monacoEditor) {
                        const editorCode = window.monacoEditor.getValue();
                        if (editorCode.trim()) {
                            finalPrompt = `Context Code:\n\`\`\`${language}\n${editorCode}\n\`\`\`\n\nRequest: ${prompt}`;
                        }
                    }

                    if (feedback) {
                        feedback.innerHTML = `
                            <div class="space-y-4 p-2">
                                <div class="flex items-center gap-2 text-emerald-400 mb-4"><i class="fas fa-spinner fa-spin"></i> <span class="text-sm font-bold">Generating ${language} code...</span></div>
                                <div class="skeleton h-12 w-full"></div>
                                <div class="skeleton h-64 w-full"></div>
                                <div class="skeleton h-12 w-1/2"></div>
                            </div>`;
                    }
                    
                    const frameworkStr = framework !== 'none' ? ` using ${framework}` : '';

                    // STREAMING IMPLEMENTATION (Client-Side Hook)
                    async function streamAIResponse(promptText) {
                        // This simulates how you would consume a streaming endpoint
                        // Replace URL with your actual streaming endpoint
                        const response = await fetch(`http://localhost:8000/api/generate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                prompt: promptText,
                                language: language,
                                user_type: userType,
                                model: model,
                                stream: true // Flag for backend
                            })
                        });
                        
                        // Fallback to normal JSON if backend doesn't support stream yet
                        return await response.json();
                    }

                    try {
                        const styleMap = {
                            'production': 'Optimized production code',
                            'educational': 'Well-commented code for learning',
                            'compact': 'Minimal and compact code',
                            'verbose': 'Detailed and verbose code'
                        };

                        const data = await streamAIResponse(`${styleMap[style]}${frameworkStr}: ${finalPrompt}`);
                        const generatedCode = data.generated_code || '';
                        
                        // Insert into Monaco
                        if(window.monacoEditor) {
                            window.monacoEditor.setValue(generatedCode);
                            // Try to set language
                            const langMap = {'python':'python', 'javascript':'javascript', 'java':'java', 'cpp':'cpp', 'csharp':'csharp', 'go':'go', 'rust':'rust', 'typescript':'typescript'};
                            if(langMap[language]) monaco.editor.setModelLanguage(window.monacoEditor.getModel(), langMap[language]);
                        }

                        if (feedback) {
                            feedback.innerHTML = `<div class='bg-emerald-900/20 border border-emerald-700/50 rounded-lg p-4 mb-4'>
                                <p class='text-emerald-400 font-bold'><i class='fas fa-check-circle mr-2'></i>Code Generated Successfully!</p>
                                <p class='text-emerald-300 text-sm mt-1'>Language: <strong>${language.toUpperCase()}</strong> | Style: <strong>${style}</strong></p>
                            </div>`;
                        }

                        showToast('‚úÖ Code generated! Advanced tools ready', 'success');
                        
                        // Show advanced features
                        const advFeatures = get('advanced-features');
                        if (advFeatures) {
                            setTimeout(() => advFeatures.classList.remove('hidden'), 1000);
                        }

                        // Save for downloads
                        window.downloadData = {
                            code: generatedCode,
                            review: `Generated ${language} code\n\nPrompt: ${prompt}`,
                            language: language,
                            originalCode: generatedCode,
                            stats: { critical: 0, high: 0, medium: 0, low: 0 },
                            complexity_original: "Fresh",
                            complexity_rewritten: generatedCode ? "Generated" : "N/A"
                        };

                        if (typeof hljs !== 'undefined') hljs.highlightAll();

                    } catch (err) {
                        if (feedback) feedback.innerHTML = `<p class="text-red-400"><i class="fas fa-exclamation-circle mr-2"></i>Error: ${err.message}</p>`;
                        showToast("Generation failed", "error");
                    }
                });

                // Copy Button
                setClick('copyBtn', function() {
                    const output = get('rewrittenCodeOutput');
                    if (output) {
                        navigator.clipboard.writeText(output.textContent);
                        const btn = get('copyBtn');
                        if (btn) {
                            const originalHtml = btn.innerHTML;
                            btn.innerHTML = '<i class="fas fa-check text-green-400"></i>';
                            setTimeout(() => btn.innerHTML = originalHtml, 2000);
                        }
                        showToast("Code copied to clipboard", "success");
                    }
                });

                // Downloads
                const triggerDownload = (blob, filename) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = filename;
                    document.body.appendChild(a); a.click();
                    window.URL.revokeObjectURL(url); a.remove();
                };

                setClick('downloadCodeFileBtn', () => {
                    if (!window.downloadData) return showToast('Run Auto-Rewrite first', 'warning');
                    const extMap = { 'python': 'py', 'java': 'java', 'javascript': 'js', 'cpp': 'cpp' };
                    const ext = extMap[window.downloadData.language] || 'txt';
                    const blob = new Blob([window.downloadData.code], { type: 'text/plain' });
                    triggerDownload(blob, `refactored_code.${ext}`);
                });

                setClick('downloadSummaryBtn', async () => {
                    if (!window.downloadData) return showToast('Run Auto-Rewrite first', 'warning');
                    const formatEl = document.querySelector('input[name="downloadFormat"]:checked');
                    const format = formatEl ? formatEl.value : 'docx';
                    
                    try {
                        const res = await fetch('http://localhost:8000/api/download/summary', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ format, review: window.downloadData.review, stats: window.downloadData.stats })
                        });
                        if (res.ok) triggerDownload(await res.blob(), `summary.${format}`);
                        else throw new Error("Download failed");
                    } catch (e) { showToast("Download failed", "error"); }
                });

                setClick('downloadReportBtn', async () => {
                    if (!window.downloadData) return showToast('Run Auto-Rewrite first', 'warning');
                    const formatEl = document.querySelector('input[name="downloadFormat"]:checked');
                    const format = formatEl ? formatEl.value : 'docx';
                    
                    try {
                        const res = await fetch('http://localhost:8000/api/download/report', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                format, ...window.downloadData,
                                original_code: window.downloadData.originalCode,
                                rewritten_code: window.downloadData.code
                            })
                        });
                        if (res.ok) triggerDownload(await res.blob(), `report.${format}`);
                        else throw new Error("Download failed");
                    } catch (e) { showToast("Download failed", "error"); }
                });
                
                // Mode Switching - UNIFIED HANDLER
                const setupModeButtons = () => {
                    const btnAnalysis = document.getElementById('modeAnalysis');
                    const btnGenerate = document.getElementById('modeGenerate');
                    
                    const setActive = (btn) => {
                        [btnAnalysis, btnGenerate].forEach(b => {
                            if (b) {
                                b.classList.remove('active', 'bg-sky-600', 'border-sky-600', 'bg-emerald-600', 'border-emerald-600', 'text-white');
                                b.classList.add('bg-slate-700', 'border-slate-700', 'text-slate-300');
                                b.classList.remove('hidden'); // Reset visibility
                            }
                        });
                        if (btn) {
                            btn.classList.remove('bg-slate-700', 'border-slate-700', 'text-slate-300');
                            btn.classList.add('active', 'text-white');
                            if (btn === btnAnalysis) btn.classList.add('bg-sky-600', 'border-sky-600');
                            if (btn === btnGenerate) btn.classList.add('bg-emerald-600', 'border-emerald-600');
                        }
                    };

                    if (btnAnalysis) {
                        btnAnalysis.addEventListener('click', (e) => {
                            if(e) e.preventDefault();
                            setActive(btnAnalysis);
                        });
                    }

                    if (btnGenerate) {
                        btnGenerate.addEventListener('click', (e) => {
                            if(e) e.preventDefault();
                            // Navigate to dedicated generation page
                            window.location.href = '/generate';
                        });
                    }
                };
                setupModeButtons();

                // Advanced Features
                setClick('generateTestsBtn', async () => {
                    if (!window.downloadData) return showToast('Generate or analyze code first', 'warning');
                    const feedback = get('reviewFeedback');
                    if (feedback) feedback.innerHTML = '<p class="text-blue-400"><i class="fas fa-spinner animate-spin mr-2"></i>Generating tests...</p>';
                    try {
                        const res = await fetch('http://localhost:8000/api/generate-tests', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: window.downloadData.code, language: window.downloadData.language })
                        });
                        const data = await res.json();
                        if (feedback) feedback.innerHTML = `<h4 class="text-emerald-400 font-bold mb-2">Unit Tests</h4><pre class="bg-slate-800 p-3 rounded text-sm overflow-auto max-h-96"><code>${data.tests.replace(/</g, '&lt;')}</code></pre>`;
                    } catch (e) { showToast("Test generation failed", "error"); }
                });

                setClick('generateDocsBtn', async () => {
                    if (!window.downloadData) return showToast('Generate or analyze code first', 'warning');
                    const feedback = get('reviewFeedback');
                    if (feedback) feedback.innerHTML = '<p class="text-blue-400"><i class="fas fa-spinner animate-spin mr-2"></i>Generating docs...</p>';
                    try {
                        const res = await fetch('http://localhost:8000/api/generate-docs', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: window.downloadData.code, language: window.downloadData.language })
                        });
                        const data = await res.json();
                        if (feedback) feedback.innerHTML = `<h4 class="text-blue-400 font-bold mb-2">Documentation</h4><div class="bg-slate-800 p-3 rounded max-h-96 overflow-auto">${typeof marked !== 'undefined' ? marked.parse(data.documentation) : data.documentation}</div>`;
                    } catch (e) { showToast("Docs generation failed", "error"); }
                });

                setClick('securityScanBtn', async () => {
                    if (!window.downloadData) return showToast('Generate or analyze code first', 'warning');
                    const feedback = get('reviewFeedback');
                    if (feedback) feedback.innerHTML = '<p class="text-yellow-400"><i class="fas fa-spinner animate-spin mr-2"></i>Scanning...</p>';
                    try {
                        const res = await fetch('http://localhost:8000/api/security-scan', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: window.downloadData.code, language: window.downloadData.language })
                        });
                        const data = await res.json();
                        if (feedback) feedback.innerHTML = `<h4 class="text-red-400 font-bold mb-2">Security Analysis</h4><div class="bg-slate-800 p-3 rounded max-h-96 overflow-auto whitespace-pre-wrap text-sm">${data.security_analysis.replace(/</g, '&lt;')}</div>`;
                    } catch (e) { showToast("Security scan failed", "error"); }
                });

                setClick('refactorSuggestionsBtn', async () => {
                    if (!window.downloadData) return showToast('Generate or analyze code first', 'warning');
                    const feedback = get('reviewFeedback');
                    if (feedback) feedback.innerHTML = '<p class="text-purple-400"><i class="fas fa-spinner animate-spin mr-2"></i>Analyzing...</p>';
                    try {
                        const res = await fetch('http://localhost:8000/api/refactor-suggestions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: window.downloadData.code, language: window.downloadData.language })
                        });
                        const data = await res.json();
                        if (feedback) feedback.innerHTML = `<h4 class="text-purple-400 font-bold mb-2">Refactoring Suggestions</h4><div class="bg-slate-800 p-3 rounded max-h-96 overflow-auto">${typeof marked !== 'undefined' ? marked.parse(data.refactoring_suggestions) : data.refactoring_suggestions}</div>`;
                    } catch (e) { showToast("Analysis failed", "error"); }
                });

                setClick('saveSnippetBtn', () => {
                    if (!window.downloadData) return showToast('Generate or analyze code first', 'warning');
                    const title = prompt('Snippet title:', 'My Code Snippet');
                    if (!title) return;
                    
                    fetch('http://localhost:8000/api/snippets/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: userType, title, code: window.downloadData.code, language: window.downloadData.language })
                    }).then(res => res.json()).then(data => {
                        showToast(`‚úÖ Snippet saved as #${data.snippet_id}`, 'success');
                    }).catch(err => showToast("Save failed", "error"));
                });

                setClick('viewHistoryBtn', async () => {
                    const feedback = get('reviewFeedback');
                    try {
                        const res = await fetch(`http://localhost:8000/api/history/${userType}`);
                        const data = await res.json();
                        if (data.history.length === 0) {
                            if (feedback) feedback.innerHTML = '<p class="text-slate-400">No version history yet.</p>';
                            return;
                        }
                        let html = `<h4 class="text-cyan-400 font-bold mb-2">Code History (${data.total_versions} versions)</h4>`;
                        data.history.forEach(v => {
                            html += `<div class="bg-slate-700 p-2 rounded mb-2"><p class="text-sm text-cyan-300">Version ${v.version} - ${v.action} (${new Date(v.timestamp).toLocaleString()})</p></div>`;
                        });
                        if (feedback) feedback.innerHTML = html;
                    } catch (e) { showToast("History fetch failed", "error"); }
                });

                // Diff View
                setClick('toggleDiffBtn', () => {
                    const codeSection = get('codeDisplaySection');
                    const diffContainer = get('diffViewContainer');
                    
                    if (diffContainer && diffContainer.classList.contains('hidden')) {
                        if (!window.downloadData || !window.downloadData.originalCode) return showToast('No code to diff', 'warning');
                        
                        if (typeof Diff !== 'undefined' && typeof Diff2HtmlUI !== 'undefined') {
                            const diffStr = Diff.createTwoFilesPatch("Original", "Rewritten", window.downloadData.originalCode, window.downloadData.code);
                            const ui = new Diff2HtmlUI(diffContainer, diffStr, {
                                drawFileList: false,
                                matching: 'lines',
                                outputFormat: 'side-by-side'
                            });
                            
                            if (codeSection) codeSection.classList.add('hidden');
                            diffContainer.classList.remove('hidden');
                            ui.draw();
                        } else {
                            showToast("Diff library not loaded", "error");
                        }
                    } else {
                        if (codeSection) codeSection.classList.remove('hidden');
                        if (diffContainer) diffContainer.classList.add('hidden');
                    }
                });

                // Theme Toggle
                const themeToggle = get('theme-toggle');
                if (themeToggle) {
                    const getPreferredTheme = () => {
                        const savedTheme = localStorage.getItem('theme');
                        if (savedTheme) return savedTheme;
                        return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
                    };
                    const theme = getPreferredTheme();
                    document.body.classList.toggle('light-mode', theme === 'light');
                    themeToggle.innerHTML = theme === 'light' ? '<i class="fas fa-sun text-yellow-500"></i>' : '<i class="fas fa-moon text-yellow-400"></i>';
                    
                    themeToggle.onclick = () => {
                        const isLight = document.body.classList.toggle('light-mode');
                        localStorage.setItem('theme', isLight ? 'light' : 'dark');
                        themeToggle.innerHTML = isLight ? '<i class="fas fa-sun text-yellow-500"></i>' : '<i class="fas fa-moon text-yellow-400"></i>';
                        showToast(`Switched to ${isLight ? 'Light' : 'Dark'} mode`, 'success');
                        
                        // Update Monaco Theme
                        if (window.monacoEditor) monaco.editor.setTheme(isLight ? 'vs' : 'vs-dark');
                    };
                }

                // Search
                const searchBox = get('search-results');
                if (searchBox) {
                    searchBox.oninput = () => {
                        const query = searchBox.value.toLowerCase();
                        const feedback = get('reviewFeedback');
                        if (!feedback) return;
                        
                        if (!query) {
                            feedback.classList.remove('search-highlight');
                            return;
                        }
                        
                        if (feedback.innerText.toLowerCase().includes(query)) {
                            feedback.classList.add('search-highlight');
                        } else {
                            feedback.classList.remove('search-highlight');
                        }
                    };
                }

                // Drag & Drop
                const setupDragDrop = () => {
                    const dropZone = document.getElementById('monaco-container'); // Use container for drop
                    if (!dropZone) return;
                    
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        dropZone.addEventListener(eventName, (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                        });
                    });
                    
                    ['dragenter', 'dragover'].forEach(eventName => {
                        dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
                    });
                    
                    ['dragleave', 'drop'].forEach(eventName => {
                        dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
                    });
                    
                    dropZone.addEventListener('drop', (e) => {
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            const file = files[0];
                            if (file.type.startsWith('text') || file.name.endsWith('.py') || file.name.endsWith('.js') || file.name.endsWith('.java') || file.name.endsWith('.cpp')) {
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    if (window.monacoEditor) window.monacoEditor.setValue(event.target.result);
                                    showToast(`‚úÖ File uploaded: ${file.name}`, 'success');
                                };
                                reader.readAsText(file);
                            } else {
                                showToast('‚ùå Please drop valid code files', 'error');
                            }
                        }
                    });
                };
                setupDragDrop();

                // Keyboard Shortcuts
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        const btn = get('reviewBtn');
                        if (btn) btn.click();
                    } else if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
                        e.preventDefault();
                        window.location.href = '/generate';
                    } else if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        const search = get('search-results');
                        if (search) {
                            search.classList.toggle('hidden');
                            if (!search.classList.contains('hidden')) search.focus();
                        }
                    } else if (e.altKey && e.shiftKey && e.key === 'F') {
                        e.preventDefault();
                        formatCode();
                    } else if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                        e.preventDefault();
                        cmdPalette.classList.remove('hidden');
                        cmdInput.focus();
                        renderCommands();
                    } else if (e.key === 'Escape') {
                        cmdPalette.classList.add('hidden');
                        settingsModal.classList.add('hidden');
                    }
                });

                // Voice Coding (Web Speech API)
                setClick('voiceCodeBtn', () => {
                    if (!('webkitSpeechRecognition' in window)) return showToast("Voice not supported in this browser", "error");
                    const recognition = new webkitSpeechRecognition();
                    recognition.lang = 'en-US';
                    recognition.start();
                    showToast("Listening...", "info");
                    
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript.toLowerCase();
                        showToast(`Heard: "${transcript}"`, "info");
                        if(transcript.includes("format")) formatCode();
                        else if(transcript.includes("run")) runCode();
                        else if(transcript.includes("clear")) get('clearEditorBtn').click();
                    }
                });
                
                // Quick Prompts Logic
                const quickPrompts = document.getElementById('quickPrompts');
                if (quickPrompts) {
                    quickPrompts.addEventListener('click', (e) => {
                        if (e.target.tagName === 'BUTTON') {
                            const promptInput = get('generationPrompt');
                            if (promptInput) {
                                promptInput.value = e.target.innerText + ": ";
                                promptInput.focus();
                            }
                        }
                    });
                }
                
                // Framework Selector Logic
                const frameworks = {
                    python: ['Flask', 'Django', 'FastAPI', 'Pandas', 'NumPy', 'PyTorch', 'TensorFlow'],
                    javascript: ['React', 'Vue', 'Angular', 'Node.js', 'Express', 'Next.js'],
                    typescript: ['React', 'Angular', 'NestJS', 'Next.js'],
                    java: ['Spring Boot', 'Hibernate', 'Android SDK'],
                    cpp: ['Qt', 'Boost', 'Unreal Engine'],
                    csharp: ['.NET Core', 'ASP.NET', 'Unity', 'WPF'],
                    go: ['Gin', 'Echo', 'Fiber'],
                    rust: ['Actix', 'Rocket', 'Tokio']
                };
                
                const langSelectGen = get('generationLanguage');
                const frameworkSelect = get('generationFramework');
                
                const updateFrameworks = () => {
                    if (!langSelectGen || !frameworkSelect) return;
                    const lang = langSelectGen.value;
                    const opts = frameworks[lang] || [];
                    frameworkSelect.innerHTML = '<option value="none">None / Standard Library</option>';
                    opts.forEach(fw => {
                        const option = document.createElement('option');
                        option.value = fw;
                        option.innerText = fw;
                        frameworkSelect.appendChild(option);
                    });
                };
                
                if (langSelectGen) {
                    langSelectGen.addEventListener('change', updateFrameworks);
                    updateFrameworks(); // Initialize
                }

                // Tooltips
                const rBtn = get('reviewBtn');
                if (rBtn) rBtn.title = "Run Review (Ctrl+Enter)";
                const gBtn = get('generateBtn');
                if (gBtn) gBtn.title = "Generate Code (Ctrl+G)";

                // Logout Function
                window.logout = function() {
                    localStorage.removeItem('token');
                    sessionStorage.removeItem('token');
                    window.location.href = '/login';
                };

                console.log("‚úÖ Code Refine: Initialization Complete");

            } catch (criticalError) {
                console.error("CRITICAL INIT ERROR:", criticalError);
                alert("Application failed to initialize. Check console for details.");
            }
        };

        // Run Init
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>