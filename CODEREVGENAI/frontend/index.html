<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Refine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <!-- Diff View Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/diff2html/3.4.22/diff2html.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff2html/3.4.22/diff2html-ui.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border-color: #334155;
            --accent-color: #0ea5e9;
        }

        body.light-mode {
            --bg-primary: #f1f5f9;
            --bg-secondary: #e2e8f0;
            --bg-tertiary: #cbd5e1;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #cbd5e1;
            --accent-color: #0284c7;
        }

        /* MASTER THEME OVERRIDE - Forces all color classes to use CSS variables */
        .bg-slate-900 { background-color: var(--bg-primary) !important; }
        .bg-slate-800 { background-color: var(--bg-secondary) !important; }
        .bg-slate-700 { background-color: var(--bg-tertiary) !important; }
        .bg-slate-600 { background-color: var(--bg-tertiary) !important; }

        .text-slate-50 { color: var(--text-primary) !important; }
        .text-slate-300 { color: var(--text-secondary) !important; }
        .text-slate-400 { color: var(--text-secondary) !important; }
        .text-slate-500 { color: var(--text-secondary) !important; }

        .border-slate-700, .border-slate-600 { border-color: var(--border-color) !important; }

        * { color: inherit; }
        body { background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        nav { background-color: var(--bg-secondary) !important; color: var(--text-primary) !important; border-bottom-color: var(--border-color) !important; }
        .container { color: var(--text-primary); background-color: transparent; }
        h1, h2, h3, h4, h5, h6 { color: var(--text-primary) !important; }

        /* Form Elements */
        input, textarea, select { background-color: var(--bg-secondary) !important; color: var(--text-primary) !important; border-color: var(--border-color) !important; }
        input::placeholder, textarea::placeholder { color: var(--text-secondary) !important; }
        input:focus, textarea:focus, select:focus { border-color: var(--accent-color) !important; }

        /* Code Elements */
        .code-editor { font-family: 'Fira Code', monospace; background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .code-output { background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); overflow-x: auto; }

        /* Buttons */
        .btn-primary { background: linear-gradient(to right, #2563eb, #9333ea); transition: all 0.3s; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .mode-tab { cursor: pointer; transition: all 0.2s; }
        .mode-tab.active { font-weight: bold; }

        /* Panels */
        .analysis-mode, .generation-mode { transition: opacity 0.3s ease-in-out; }
        .hidden { display: none; }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
        }

        .toast {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
            pointer-events: auto;
        }

        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.info { border-left: 4px solid var(--accent-color); }
        .toast.warning { border-left: 4px solid #f59e0b; }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            to { transform: translateX(400px); opacity: 0; }
        }

        .toast.removing { animation: slideOut 0.3s ease-in forwards; }

        /* Drag & Drop */
        .drag-over { background-color: var(--accent-color) !important; opacity: 0.5; border-color: var(--accent-color) !important; }

        /* Search Results Highlight */
        .search-highlight { background-color: rgba(34, 197, 94, 0.3); border-left: 3px solid #22c55e; }

        .prose pre { background: transparent !important; padding: 0 !important; }

        /* Skeleton Loader */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 0.5rem;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-50 min-h-screen">
    <!-- Toast Container -->
    <div id="toast-container"></div>

    <nav class="bg-slate-800 p-4 border-b border-slate-700 shadow-xl">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-3xl"></span>
                <div>
                    <h1 id="platform-title" class="text-xl font-bold text-sky-400 leading-none">Code Refine</h1>
                    <p id="platform-subtitle" class="text-xs text-slate-400 mt-1 uppercase tracking-widest font-semibold">Developer Edition</p>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <div id="student-tracking" class="hidden flex items-center gap-3 bg-slate-700/50 px-4 py-1.5 rounded-lg border border-slate-600">
                    <span class="text-[10px] text-slate-400 uppercase font-bold">Total Reviews:</span>
                    <span id="review-count" class="text-sky-400 font-bold">0</span>
                </div>
                <input type="text" id="search-results" placeholder="Search results..." class="hidden px-3 py-1.5 bg-slate-700 border border-slate-600 rounded-lg text-sm text-slate-300 outline-none focus:border-sky-500 w-40">
                <button id="theme-toggle" title="Toggle dark/light mode" class="p-2 rounded-lg hover:bg-slate-700 transition-colors">
                    <i class="fas fa-moon text-yellow-400"></i>
                </button>
                <span id="user-badge" class="px-3 py-1 rounded-full bg-slate-700 text-xs font-bold border border-slate-600">Standard</span>
                <a href="/" class="text-slate-400 hover:text-white transition-colors"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="space-y-4">
                
                <div class="grid grid-cols-1 gap-4">
                    <div id="policy-upload-zone" class="hidden bg-slate-800 p-3 rounded-xl border border-dashed border-sky-500/40">
                        <label class="text-[10px] font-bold text-sky-400 block mb-2 uppercase italic"><i class="fas fa-file-shield mr-1"></i> Upload Company Policy</label>
                        <input type="file" id="policyFile" accept=".txt,.pdf" class="text-[10px] text-slate-500 file:mr-3 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-sky-500/10 file:text-sky-400 cursor-pointer">
                    </div>
                </div>

                <!-- Tab Selection -->
                <div class="flex gap-2 mb-4 flex-wrap">
                    <button id="modeAnalysis" class="mode-tab active px-4 py-2 rounded-lg font-bold text-sm border transition-all bg-sky-600 border-sky-600 text-white">
                        <i class="fas fa-microscope mr-2"></i>Analyze Code
                    </button>
                    <button id="modeGenerate" class="mode-tab px-4 py-2 rounded-lg font-bold text-sm border transition-all bg-slate-700 border-slate-700 text-slate-300 hover:bg-slate-600">
                        <i class="fas fa-sparkles mr-2"></i>Generate Code
                    </button>
                </div>

                <!-- Analysis Mode -->
                <div id="analysis-panel" class="analysis-mode space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fas fa-code text-sky-400"></i> Source Code
                            <span id="detectedLangDisplay" class="text-xs text-slate-500 ml-2 font-normal hidden"></span>
                        </h2>
                    </div>
                    
                    <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                        <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide">
                            <i class="fas fa-brain text-purple-400 mr-2"></i>AI Model
                        </label>
                        <select id="modelSelectorAnalysis" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-purple-500/50">
                            <option value="llama-3.3-70b">ðŸ¦™ Llama 3.3 70B (Fast & Accurate)</option>
                            <option value="llama-3.1-405b">ðŸ¦™ Llama 3.1 405B (Most Accurate)</option>
                            <option value="mixtral-8x7b-32768">ðŸŽ¯ Mixtral 8x7B (Fastest)</option>
                            <option value="gemini-pro">âœ¨ Gemini Pro (Google)</option>
                        </select>
                    </div>

                    <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                        <label class="text-[10px] font-bold text-slate-400 block mb-2 uppercase italic"><i class="fas fa-camera mr-1"></i> Scan Code from Image</label>
                        <input type="file" id="ocrFile" accept="image/*" class="text-[10px] text-slate-500 file:mr-3 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-sky-500/10 file:text-sky-400 cursor-pointer">
                    </div>
                    
                    <textarea id="codeInput" class="code-editor w-full h-80 p-4 rounded-xl outline-none focus:ring-2 focus:ring-sky-500/50 dropzone" placeholder="Enter your code or upload an image...&#10;ðŸ’¡ Tip: Drag & drop code files here or use Keyboard Shortcuts (Ctrl+Enter to Review, Ctrl+G to Generate)"></textarea>
                    
                    <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                        <p class="text-sm font-bold mb-3 text-slate-400 uppercase tracking-tighter">Analysis Focus Areas</p>
                        <div class="flex flex-wrap gap-4 text-sm">
                            <label class="flex items-center cursor-pointer"><input type="checkbox" name="focusArea" value="Bugs" checked class="mr-2 accent-sky-500">Bugs</label>
                            <label class="flex items-center cursor-pointer"><input type="checkbox" name="focusArea" value="Performance" checked class="mr-2 accent-sky-500">Performance</label>
                            <label class="flex items-center cursor-pointer"><input type="checkbox" name="focusArea" value="Security" checked class="mr-2 accent-sky-500">Security</label>
                            <label class="flex items-center cursor-pointer"><input type="checkbox" name="focusArea" value="Best Practices" checked class="mr-2 accent-sky-500">Best Practices</label>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <button id="reviewBtn" class="btn-primary font-bold py-3 px-4 rounded-xl shadow-lg flex items-center justify-center gap-2">
                            <i class="fas fa-microscope"></i> Run Review
                        </button>
                        <button id="fixBtn" class="bg-slate-700 hover:bg-slate-600 font-bold py-3 px-4 rounded-xl border border-slate-600 flex items-center justify-center gap-2">
                            <i class="fas fa-wand-magic-sparkles"></i> Auto-Rewrite
                        </button>
                    </div>
                </div>

                <!-- Generation Mode -->
                <div id="generation-panel" class="generation-mode hidden space-y-4">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fas fa-sparkles text-emerald-400"></i> Describe Your Code
                    </h2>
                    
                    <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                        <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide">
                            <i class="fas fa-brain text-purple-400 mr-2"></i>AI Model
                        </label>
                        <select id="modelSelectorGeneration" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-purple-500/50">
                            <option value="llama-3.3-70b">ðŸ¦™ Llama 3.3 70B (Fast & Accurate)</option>
                            <option value="llama-3.1-405b">ðŸ¦™ Llama 3.1 405B (Most Accurate)</option>
                            <option value="mixtral-8x7b-32768">ðŸŽ¯ Mixtral 8x7B (Fastest)</option>
                            <option value="gemini-pro">âœ¨ Gemini Pro (Google)</option>
                        </select>
                    </div>

                    <div class="space-y-3">
                        <label class="block text-sm font-bold text-slate-300">
                            <i class="fas fa-lightbulb mr-2 text-yellow-400"></i>What code do you want to generate?
                        </label>
                        <div class="relative">
                            <textarea id="generationPrompt" class="code-editor w-full h-24 p-4 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500/50" placeholder="Example: Create a Python function to sort an array in descending order using merge sort algorithm"></textarea>
                            <button id="voiceBtn" class="absolute bottom-3 right-3 text-slate-400 hover:text-emerald-400 transition-colors p-2" title="Speak Prompt">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-300 mb-2">
                                <i class="fas fa-code text-sky-400 mr-2"></i>Language
                            </label>
                            <select id="generationLanguage" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500/50">
                                <option value="python">Python</option>
                                <option value="javascript">JavaScript</option>
                                <option value="java">Java</option>
                                <option value="cpp">C++</option>
                                <option value="csharp">C#</option>
                                <option value="go">Go</option>
                                <option value="rust">Rust</option>
                                <option value="typescript">TypeScript</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-slate-300 mb-2">
                                <i class="fas fa-user-tie text-purple-400 mr-2"></i>Code Style
                            </label>
                            <select id="generationStyle" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm outline-none focus:ring-2 focus:ring-emerald-500/50">
                                <option value="production">Production (Optimized)</option>
                                <option value="educational">Educational (Commented)</option>
                                <option value="compact">Compact (Minimal)</option>
                                <option value="verbose">Verbose (Detailed)</option>
                            </select>
                        </div>
                    </div>

                    <button id="generateBtn" class="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 font-bold py-3 px-4 rounded-xl shadow-lg flex items-center justify-center gap-2 text-white transition-all transform hover:scale-[1.02] active:scale-95">
                        <i class="fas fa-wand-magic-sparkles"></i> Generate Code
                    </button>
                </div>

            <div class="flex flex-col">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fas fa-chart-pie text-purple-400"></i> Analysis Results
                    </h2>
                    <div id="plagiarism-badge" class="hidden px-3 py-1 bg-orange-900/40 border border-orange-700 rounded-lg">
                        <span class="text-[10px] text-orange-300 font-bold uppercase">Similarity: </span>
                        <span id="plag-score" class="text-xs font-bold text-white">0%</span>
                    </div>
                </div>
                
                <div id="reviewResults" class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-2xl flex-grow overflow-y-auto max-h-[550px]">
                    <div class="grid grid-cols-4 gap-3 text-center mb-6">
                        <div class="p-2 bg-red-900/40 border border-red-700/50 rounded-xl">
                            <p id="critical-count" class="font-bold text-2xl text-red-400">0</p>
                            <p class="text-[10px] uppercase font-bold text-red-300">Critical</p>
                        </div>
                        <div class="p-2 bg-orange-900/40 border border-orange-700/50 rounded-xl">
                            <p id="high-count" class="font-bold text-2xl text-orange-400">0</p>
                            <p class="text-[10px] uppercase font-bold text-orange-300">High</p>
                        </div>
                        <div class="p-2 bg-yellow-900/40 border border-yellow-700/50 rounded-xl">
                            <p id="medium-count" class="font-bold text-2xl text-yellow-400">0</p>
                            <p class="text-[10px] uppercase font-bold text-yellow-300">Medium</p>
                        </div>
                        <div class="p-2 bg-blue-900/40 border border-blue-700/50 rounded-xl">
                             <p id="low-count" class="font-bold text-2xl text-blue-400">0</p>
                             <p class="text-[10px] uppercase font-bold text-blue-300">Low</p>
                        </div>
                    </div>
                    <div id="reviewFeedback" class="prose prose-invert max-w-none text-slate-300">
                        <p class="italic text-slate-500">Run a review to see AI insights...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-12 bg-slate-800/30 p-6 rounded-3xl border border-slate-800">
            <h2 class="text-xl font-bold mb-6 text-center text-slate-400 uppercase tracking-widest">Code Transformation & Analysis</h2>
            
            <div id="complexity-section" class="hidden mb-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-slate-700/50 p-5 rounded-2xl border border-orange-700/30">
                    <h3 class="text-sm font-bold text-orange-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                        <i class="fas fa-clock"></i> Original Code Complexity
                    </h3>
                    <div class="flex items-center gap-3">
                        <div class="text-4xl font-black text-orange-400" id="original-complexity-display">O(n)</div>
                        <p class="text-xs text-slate-400">Time complexity of the original code</p>
                    </div>
                </div>
                
                <div class="bg-slate-700/50 p-5 rounded-2xl border border-green-700/30">
                    <h3 class="text-sm font-bold text-green-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                        <i class="fas fa-rocket"></i> Optimized Code Complexity
                    </h3>
                    <div class="flex items-center gap-3">
                        <div class="text-4xl font-black text-green-400" id="rewritten-complexity-display">O(n)</div>
                        <p class="text-xs text-slate-400">Time complexity of the rewritten code</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-end mb-2">
                <button id="toggleDiffBtn" class="hidden text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded border border-slate-600 text-slate-300"><i class="fas fa-columns mr-1"></i> Toggle Diff View</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="codeDisplaySection">
                <div id="originalCodeSection">
                    <h3 class="text-sm font-bold mb-2 text-slate-500 px-2 uppercase italic">Original Input</h3>
                    <pre class="code-output rounded-xl p-4 min-h-[200px]"><code id="originalCodeOutput" class="language-python"></code></pre>
                </div>
                <div class="relative" id="generatedCodeSection">
                    <h3 class="text-sm font-bold mb-2 text-sky-400 px-2 uppercase italic">AI Rewritten Version</h3>
                     <pre class="code-output rounded-xl p-4 min-h-[200px] border-sky-900/30"><code id="rewrittenCodeOutput" class="language-python"></code></pre>
                     <div class="absolute top-10 right-4 flex gap-2">
                         <button id="copyBtn" class="bg-slate-700/80 hover:bg-sky-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-slate-600">
                             <i class="fas fa-copy mr-1"></i> Copy Code
                         </button>
                         <button id="downloadCodeBtn" class="hidden bg-slate-700/80 hover:bg-emerald-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-slate-600">
                             <i class="fas fa-download mr-1"></i> Download Code
                         </button>
                     </div>
                </div>
            </div>

            <!-- Diff View Container -->
            <div id="diffViewContainer" class="hidden bg-white rounded-xl overflow-hidden p-1"></div>

            <!-- Generation Mode Placeholder -->
            <div id="generationPlaceholder" class="hidden mt-8">
                <div class="bg-gradient-to-br from-emerald-900/20 to-teal-900/20 border border-emerald-700/40 rounded-3xl p-12 text-center">
                    <div class="text-6xl mb-4"><i class="fas fa-magic text-emerald-400"></i></div>
                    <h3 class="text-2xl font-bold text-emerald-300 mb-2">Ready to Generate Code</h3>
                    <p class="text-slate-400">Enter your prompt above and click "Generate Code" to create your custom code</p>
                </div>
            </div>

            <!-- Advanced Features Section -->
            <div id="advanced-features" class="hidden mt-8 pt-8 border-t border-slate-700">
                <h3 class="text-lg font-bold mb-4 text-slate-400 uppercase tracking-wide flex items-center gap-2">
                    <i class="fas fa-flask-vial"></i> Advanced Tools
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <button id="generateTestsBtn" class="bg-slate-700/40 hover:bg-slate-600/50 border border-slate-600/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                        <i class="fas fa-flask"></i>
                        <div class="text-left">
                            <div>Generate Tests</div>
                            <div class="text-[10px] text-slate-400 font-normal">Unit test code</div>
                        </div>
                    </button>
                    
                    <button id="generateDocsBtn" class="bg-slate-700/40 hover:bg-slate-600/50 border border-slate-600/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                        <i class="fas fa-book"></i>
                        <div class="text-left">
                            <div>Generate Docs</div>
                            <div class="text-[10px] text-slate-400 font-normal">Documentation & comments</div>
                        </div>
                    </button>
                    
                    <button id="securityScanBtn" class="bg-slate-700/40 hover:bg-slate-600/50 border border-slate-600/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                        <i class="fas fa-shield-alt"></i>
                        <div class="text-left">
                            <div>Security Scan</div>
                            <div class="text-[10px] text-slate-400 font-normal">Vulnerability check</div>
                        </div>
                    </button>
                    
                    <button id="refactorSuggestionsBtn" class="bg-slate-700/40 hover:bg-slate-600/50 border border-slate-600/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                        <i class="fas fa-hammer"></i>
                        <div class="text-left">
                            <div>Refactor Suggestions</div>
                            <div class="text-[10px] text-slate-400 font-normal">Code improvement tips</div>
                        </div>
                    </button>
                    
                    <button id="saveSnippetBtn" class="bg-slate-700/40 hover:bg-slate-600/50 border border-slate-600/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                        <i class="fas fa-bookmark"></i>
                        <div class="text-left">
                            <div>Save as Snippet</div>
                            <div class="text-[10px] text-slate-400 font-normal">Save for reuse</div>
                        </div>
                    </button>
                    
                    <button id="viewHistoryBtn" class="bg-slate-700/40 hover:bg-slate-600/50 border border-slate-600/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center gap-2 transition-all">
                        <i class="fas fa-history"></i>
                        <div class="text-left">
                            <div>View History</div>
                            <div class="text-[10px] text-slate-400 font-normal">Previous versions</div>
                        </div>
                    </button>
                </div>
            </div>

            <div id="download-section" class="hidden mt-8 pt-8 border-t border-slate-700">
                <h3 class="text-lg font-bold mb-4 text-slate-400 uppercase tracking-wide flex items-center gap-2">
                    <i class="fas fa-file-download"></i> Export & Share
                </h3>
                
                <div class="mb-4 flex items-center gap-3 bg-slate-700/30 p-3 rounded-lg">
                    <span class="text-sm font-bold text-slate-400">Download Format:</span>
                    <div class="flex gap-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="downloadFormat" value="docx" checked class="accent-sky-500">
                            <span class="text-sm text-slate-300">Word (.docx)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="downloadFormat" value="pdf" class="accent-sky-500">
                            <span class="text-sm text-slate-300">PDF (.pdf)</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button id="downloadCodeFileBtn" class="bg-gradient-to-r from-emerald-900/40 to-emerald-800/20 hover:from-emerald-900/60 hover:to-emerald-800/40 border border-emerald-700/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all">
                        <i class="fas fa-code"></i>
                        <div class="text-left">
                            <div>Download Code</div>
                            <div class="text-[10px] text-slate-400 font-normal">Optimized source file</div>
                        </div>
                    </button>
                    <button id="downloadSummaryBtn" class="bg-gradient-to-r from-blue-900/40 to-blue-800/20 hover:from-blue-900/60 hover:to-blue-800/40 border border-blue-700/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all">
                        <i class="fas fa-file-alt"></i>
                        <div class="text-left">
                            <div>Download Summary</div>
                            <div class="text-[10px] text-slate-400 font-normal">Review & analysis</div>
                        </div>
                    </button>
                    <button id="downloadReportBtn" class="bg-gradient-to-r from-purple-900/40 to-purple-800/20 hover:from-purple-900/60 hover:to-purple-800/40 border border-purple-700/50 px-4 py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-all">
                        <i class="fas fa-file-pdf"></i>
                        <div class="text-left">
                            <div>Download Report</div>
                            <div class="text-[10px] text-slate-400 font-normal">Complete documentation</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * Code Refine - Main Frontend Script
         * Handles UI interactions, API calls, and state management.
         */

        // Global error handler for debugging
        window.onerror = function(msg, url, line, col, error) {
            console.error("âŒ Global Error:", msg, "\nLine:", line, "\nError:", error);
            return false;
        };

        // Initialize application when DOM is ready
        const initApp = () => {
            // Prevent double initialization
            if (window.appInitialized) return;
            window.appInitialized = true;

            console.log("ðŸš€ Code Refine: Initializing...");

            try {
                // --- 1. CONFIGURATION & STATE ---
                const params = new URLSearchParams(window.location.search);
                const userType = params.get('userType') || 'developer';
                const studentName = params.get('email') || params.get('username') || 'Guest';

                const modes = {
                    'student': { title: 'AI DEBUGGER', sub: 'STUDENT Edition', badge: 'Student' },
                    'enterprise': { title: 'Security Shield', sub: 'Enterprise Edition', badge: 'Admin' },
                    'organisation': { title: 'Team Reviewer', sub: 'Organisation Edition', badge: 'Team' },
                    'developer': { title: 'Code Refine', sub: 'Developer Edition', badge: 'Pro' }
                };

                // Safe DOM Element Access Helper
                const get = (id) => document.getElementById(id);
                
                // Robust Event Listener Helper
                const setClick = (id, handler) => {
                    const el = get(id);
                    if (el) {
                        el.addEventListener('click', async (e) => {
                            if (e && e.preventDefault) e.preventDefault();
                            console.log(`ðŸ–±ï¸ Clicked: ${id}`);
                            try {
                                await handler(e);
                            } catch (err) {
                                console.error(`Error in ${id} handler:`, err);
                                showToast(`Error: ${err.message}`, 'error');
                            }
                        });
                    } else {
                        console.warn(`âš ï¸ Element with id '${id}' not found.`);
                    }
                };

                const setChange = (id, handler) => {
                    const el = get(id);
                    if (el) {
                        el.addEventListener('change', async (e) => {
                            console.log(`ðŸ”„ Changed: ${id}`);
                            try {
                                await handler(e);
                            } catch (err) {
                                console.error(`Error in ${id} handler:`, err);
                            }
                        });
                    }
                };

                // --- 2. UI SETUP ---
                const config = modes[userType] || modes.developer;
                if (get('platform-title')) get('platform-title').innerText = config.title;
                if (get('platform-subtitle')) get('platform-subtitle').innerText = config.sub;
                if (get('user-badge')) get('user-badge').innerText = config.badge;

                if (userType === 'student') {
                    if (get('student-tracking')) get('student-tracking').classList.remove('hidden');
                    if (get('plagiarism-badge')) get('plagiarism-badge').classList.remove('hidden');
                }
                if ((userType === 'enterprise' || userType === 'organisation') && get('policy-upload-zone')) {
                    get('policy-upload-zone').classList.remove('hidden');
                }

                // --- 3. CORE FUNCTIONS ---

                // Toast Notification Helper
                const showToast = (message, type = 'info', duration = 3000) => {
                    const container = get('toast-container');
                    if (!container) return;
                    
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i><span>${message}</span>`;
                    container.appendChild(toast);
                    
                    // Animation
                    setTimeout(() => {
                        toast.classList.add('removing');
                        setTimeout(() => toast.remove(), 300);
                    }, duration);
                };

                // Process Code (Review or Rewrite)
                async function processCode(action) {
                    const codeInput = get('codeInput');
                    if (!codeInput) return;
                    
                    const code = codeInput.value;
                    if (!code.trim()) {
                        showToast("Please paste some code first!", "warning");
                        return;
                    }

                    const focusAreas = Array.from(document.querySelectorAll('input[name="focusArea"]:checked')).map(cb => cb.value);
                    
                    // Auto-detect language
                    let language = 'python';
                    if (typeof hljs !== 'undefined') {
                        try {
                            const detected = hljs.highlightAuto(code);
                            language = detected.language || 'python';
                        } catch (e) { console.warn("HighlightJS error", e); }
                    }
                    
                    // Map common aliases
                    const aliasMap = { 'js': 'javascript', 'ts': 'typescript', 'c++': 'cpp', 'cs': 'csharp', 'py': 'python' };
                    language = aliasMap[language] || language;

                    const langDisplay = get('detectedLangDisplay');
                    if (langDisplay) { 
                        langDisplay.textContent = `(Detected: ${language})`; 
                        langDisplay.classList.remove('hidden'); 
                    }
                    
                    // UI Updates for Processing State
                    const originalSection = get('originalCodeSection');
                    const codeDisplaySection = get('codeDisplaySection');
                    const generatedSection = get('generatedCodeSection');
                    const originalOutput = get('originalCodeOutput');
                    const feedback = get('reviewFeedback');
                    
                    if (originalSection) originalSection.style.display = 'block';
                    if (codeDisplaySection) {
                        codeDisplaySection.classList.remove('lg:grid-cols-1');
                        codeDisplaySection.classList.add('lg:grid-cols-2');
                        codeDisplaySection.classList.remove('hidden');
                    }
                    if (generatedSection) {
                        const h3 = generatedSection.querySelector('h3');
                        if (h3) h3.innerHTML = '<i class="fas fa-wand-magic-sparkles text-sky-400 mr-2"></i>AI Rewritten Version';
                    }
                    
                    if (originalOutput) {
                        originalOutput.textContent = code;
                        if (typeof hljs !== 'undefined') hljs.highlightElement(originalOutput);
                    }

                    if (feedback) {
                        feedback.innerHTML = `
                            <div class="space-y-4 p-2">
                                <div class="flex items-center gap-2 text-sky-400 mb-4"><i class="fas fa-spinner fa-spin"></i> <span class="text-sm font-bold">AI is analyzing your code...</span></div>
                                <div class="skeleton h-8 w-3/4"></div>
                                <div class="skeleton h-4 w-full"></div>
                                <div class="skeleton h-4 w-5/6"></div>
                                <div class="skeleton h-32 w-full"></div>
                                <div class="grid grid-cols-2 gap-4"><div class="skeleton h-20"></div><div class="skeleton h-20"></div></div>
                            </div>`;
                    }

                    try {
                        const endpoint = action === 'review' ? 'review' : 'rewrite';
                        const model = get('modelSelectorAnalysis') ? get('modelSelectorAnalysis').value : 'llama-3.3-70b';
                        const response = await fetch(`http://localhost:8000/api/${endpoint}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                code: code,
                                language: language,
                                user_type: userType,
                                student_name: studentName,
                                focus_areas: focusAreas,
                                model: model
                            })
                        });

                        if (!response.ok) throw new Error("Server Error: " + response.status);
                        const data = await response.json();

                        // Update Stats
                        if (get('critical-count')) get('critical-count').innerText = data.stats?.critical || 0;
                        if (get('high-count')) get('high-count').innerText = data.stats?.high || 0;
                        if (get('medium-count')) get('medium-count').innerText = data.stats?.medium || 0;
                        if (get('low-count')) get('low-count').innerText = data.stats?.low || 0;

                        if (userType === 'student') {
                            if (get('plag-score')) get('plag-score').innerText = data.plagiarism || "0%";
                            if (get('review-count')) get('review-count').innerText = data.student_stats || 0;
                        }

                        if (feedback) feedback.innerHTML = typeof marked !== 'undefined' ? marked.parse(data.review) : data.review;
                        
                        if (action === 'fix') {
                            const rwOut = get('rewrittenCodeOutput');
                            if (rwOut) {
                                rwOut.textContent = data.rewritten_code;
                                if (typeof hljs !== 'undefined') hljs.highlightElement(rwOut);
                            }
                            
                            if (get('complexity-section')) get('complexity-section').classList.remove('hidden');
                            if (get('original-complexity-display')) get('original-complexity-display').innerText = data.time_complexity_original || "O(n)";
                            if (get('rewritten-complexity-display')) get('rewritten-complexity-display').innerText = data.time_complexity_rewritten || "O(n)";
                            
                            if (get('download-section')) get('download-section').classList.remove('hidden');
                            if (get('downloadCodeBtn')) get('downloadCodeBtn').classList.remove('hidden');
                            if (get('toggleDiffBtn')) get('toggleDiffBtn').classList.remove('hidden');

                            // Save data for downloads
                            window.downloadData = {
                                code: data.rewritten_code,
                                review: data.review,
                                language: language,
                                originalCode: code,
                                stats: data.stats,
                                complexity_original: data.time_complexity_original || "O(n)",
                                complexity_rewritten: data.time_complexity_rewritten || "O(n)"
                            };
                        }
                        if (typeof hljs !== 'undefined') hljs.highlightAll();
                        showToast(`âœ… ${action === 'review' ? 'Review' : 'Rewrite'} Complete`, 'success');

                    } catch (err) {
                        if (feedback) feedback.innerHTML = `<p class="text-red-400">Error: ${err.message}</p>`;
                        showToast("Operation failed: " + err.message, "error");
                    }
                }

                // --- 4. EVENT LISTENERS ---

                // OCR
                setChange('ocrFile', async (e) => {
                    if (!e.target.files[0]) return;
                    
                    const codeInput = get('codeInput');
                    if (!codeInput) return;

                    const originalValue = codeInput.value;
                    codeInput.value = "â³ Scanning image... please wait...";
                    codeInput.disabled = true;
                    
                    // Switch to Analysis Mode
                    const modeAnalysis = get('modeAnalysis');
                    if (modeAnalysis) modeAnalysis.click();

                    try {
                        // 1. Try Client-Side OCR
                        if (typeof Tesseract !== 'undefined') {
                            const worker = await Tesseract.createWorker('eng');
                            const ret = await worker.recognize(e.target.files[0]);
                            await worker.terminate();
                            
                            if (ret.data.text) {
                                codeInput.value = ret.data.text;
                                showToast('âœ… OCR Complete (Client-side)', 'success');
                                return; // Success
                            }
                        }
                        throw new Error("Client OCR skipped or failed");

                    } catch (err) { 
                        console.warn("Client OCR failed, trying backend...", err);
                        // 2. Fallback to Backend
                        const formData = new FormData();
                        formData.append('file', e.target.files[0]);
                        try {
                            const res = await fetch('http://localhost:8000/api/ocr', { method: 'POST', body: formData });
                            if (!res.ok) throw new Error("Backend OCR Failed");
                            const data = await res.json();
                            codeInput.value = data.extracted_code || "// No code detected";
                            showToast('âœ… OCR Complete (Server-side)', 'success');
                        } catch (serverErr) {
                            alert("OCR Failed: " + serverErr.message);
                            codeInput.value = originalValue;
                        }
                    } finally {
                        codeInput.disabled = false;
                        e.target.value = ''; 
                    }
                });

                // Policy Upload
                setChange('policyFile', async (e) => {
                    if (!e.target.files[0]) return;
                    const formData = new FormData();
                    formData.append('file', e.target.files[0]);
                    try {
                        const res = await fetch('http://localhost:8000/api/upload-policy', { method: 'POST', body: formData });
                        const data = await res.json();
                        showToast(data.message, 'success');
                    } catch (err) { showToast("Upload failed", "error"); }
                });

                // Buttons
                setClick('reviewBtn', () => processCode('review'));
                setClick('fixBtn', () => processCode('fix'));

                // Generate Code
                setClick('generateBtn', async () => {
                    const promptInput = get('generationPrompt');
                    if (!promptInput) return;
                    
                    const prompt = promptInput.value.trim();
                    if (!prompt) {
                        showToast("Please describe what code you want to generate!", "warning");
                        return;
                    }

                    const language = get('generationLanguage') ? get('generationLanguage').value : 'python';
                    const style = get('generationStyle') ? get('generationStyle').value : 'production';
                    
                    const feedback = get('reviewFeedback');
                    const model = get('modelSelectorGeneration') ? get('modelSelectorGeneration').value : 'llama-3.3-70b';
                    if (feedback) {
                        feedback.innerHTML = `
                            <div class="space-y-4 p-2">
                                <div class="flex items-center gap-2 text-emerald-400 mb-4"><i class="fas fa-spinner fa-spin"></i> <span class="text-sm font-bold">Generating ${language} code...</span></div>
                                <div class="skeleton h-12 w-full"></div>
                                <div class="skeleton h-64 w-full"></div>
                                <div class="skeleton h-12 w-1/2"></div>
                            </div>`;
                    }

                    try {
                        const styleMap = {
                            'production': 'Optimized production code',
                            'educational': 'Well-commented code for learning',
                            'compact': 'Minimal and compact code',
                            'verbose': 'Detailed and verbose code'
                        };

                        const response = await fetch(`http://localhost:8000/api/generate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                prompt: `${styleMap[style]}: ${prompt}`,
                                language: language,
                                user_type: userType,
                                model: model
                            })
                        });

                        if (!response.ok) throw new Error("Code generation failed");
                        const data = await response.json();
                        const generatedCode = data.generated_code || '';
                        
                        // UI Updates
                        const codeDisplaySection = get('codeDisplaySection');
                        const generationPlaceholder = get('generationPlaceholder');
                        const originalSection = get('originalCodeSection');
                        const generatedSection = get('generatedCodeSection');
                        const codeElement = get('rewrittenCodeOutput');
                        const complexitySection = get('complexity-section');
                        const downloadSection = get('download-section');
                        const downloadBtn = get('downloadCodeBtn');
                        const diffBtn = get('toggleDiffBtn');

                        if (generationPlaceholder) generationPlaceholder.classList.add('hidden');
                        if (codeDisplaySection) {
                            codeDisplaySection.classList.remove('hidden');
                            codeDisplaySection.classList.remove('lg:grid-cols-2');
                            codeDisplaySection.classList.add('lg:grid-cols-1');
                        }
                        if (originalSection) originalSection.style.display = 'none';
                        
                        if (generatedSection) {
                            const h3 = generatedSection.querySelector('h3');
                            if (h3) h3.innerHTML = '<i class="fas fa-sparkles text-emerald-400 mr-2"></i>Generated Code';
                        }
                        
                        if (codeElement) {
                            codeElement.textContent = generatedCode;
                            codeElement.className = `language-${language}`;
                            if (typeof hljs !== 'undefined') hljs.highlightElement(codeElement);
                        }

                        if (complexitySection) complexitySection.classList.add('hidden');

                        if (feedback) {
                            feedback.innerHTML = `<div class='bg-emerald-900/20 border border-emerald-700/50 rounded-lg p-4 mb-4'>
                                <p class='text-emerald-400 font-bold'><i class='fas fa-check-circle mr-2'></i>Code Generated Successfully!</p>
                                <p class='text-emerald-300 text-sm mt-1'>Language: <strong>${language.toUpperCase()}</strong> | Style: <strong>${style}</strong></p>
                            </div>`;
                        }

                        if (downloadSection) downloadSection.classList.remove('hidden');
                        if (downloadBtn) downloadBtn.classList.remove('hidden');
                        if (diffBtn) diffBtn.classList.add('hidden');

                        showToast('âœ… Code generated! Advanced tools ready', 'success');
                        
                        // Show advanced features
                        const advFeatures = get('advanced-features');
                        if (advFeatures) {
                            setTimeout(() => advFeatures.classList.remove('hidden'), 1000);
                        }

                        // Save for downloads
                        window.downloadData = {
                            code: generatedCode,
                            review: `Generated ${language} code\n\nPrompt: ${prompt}`,
                            language: language,
                            originalCode: generatedCode,
                            stats: { critical: 0, high: 0, medium: 0, low: 0 },
                            complexity_original: "Fresh",
                            complexity_rewritten: generatedCode ? "Generated" : "N/A"
                        };

                        if (typeof hljs !== 'undefined') hljs.highlightAll();

                    } catch (err) {
                        if (feedback) feedback.innerHTML = `<p class="text-red-400"><i class="fas fa-exclamation-circle mr-2"></i>Error: ${err.message}</p>`;
                        showToast("Generation failed", "error");
                    }
                });

                // Copy Button
                setClick('copyBtn', function() {
                    const output = get('rewrittenCodeOutput');
                    if (output) {
                        navigator.clipboard.writeText(output.textContent);
                        const btn = get('copyBtn');
                        if (btn) {
                            const originalHtml = btn.innerHTML;
                            btn.innerHTML = '<i class="fas fa-check"></i> Copied';
                            setTimeout(() => btn.innerHTML = originalHtml, 2000);
                        }
                        showToast("Code copied to clipboard", "success");
                    }
                });

                // Downloads
                const triggerDownload = (blob, filename) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = filename;
                    document.body.appendChild(a); a.click();
                    window.URL.revokeObjectURL(url); a.remove();
                };

                setClick('downloadCodeFileBtn', () => {
                    if (!window.downloadData) return showToast('Run Auto-Rewrite first', 'warning');
                    const extMap = { 'python': 'py', 'java': 'java', 'javascript': 'js', 'cpp': 'cpp' };
                    const ext = extMap[window.downloadData.language] || 'txt';
                    const blob = new Blob([window.downloadData.code], { type: 'text/plain' });
                    triggerDownload(blob, `refactored_code.${ext}`);
                });

                setClick('downloadSummaryBtn', async () => {
                    if (!window.downloadData) return showToast('Run Auto-Rewrite first', 'warning');
                    const formatEl = document.querySelector('input[name="downloadFormat"]:checked');
                    const format = formatEl ? formatEl.value : 'docx';
                    
                    try {
                        const res = await fetch('http://localhost:8000/api/download/summary', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ format, review: window.downloadData.review, stats: window.downloadData.stats })
                        });
                        if (res.ok) triggerDownload(await res.blob(), `summary.${format}`);
                        else throw new Error("Download failed");
                    } catch (e) { showToast("Download failed", "error"); }
                });

                setClick('downloadReportBtn', async () => {
                    if (!window.downloadData) return showToast('Run Auto-Rewrite first', 'warning');
                    const formatEl = document.querySelector('input[name="downloadFormat"]:checked');
                    const format = formatEl ? formatEl.value : 'docx';
                    
                    try {
                        const res = await fetch('http://localhost:8000/api/download/report', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                format, ...window.downloadData,
                                original_code: window.downloadData.originalCode,
                                rewritten_code: window.downloadData.code
                            })
                        });
                        if (res.ok) triggerDownload(await res.blob(), `report.${format}`);
                        else throw new Error("Download failed");
                    } catch (e) { showToast("Download failed", "error"); }
                });
                
                // Mode Switching - UNIFIED HANDLER
                const setupModeButtons = () => {
                    const btnAnalysis = get('modeAnalysis');
                    const btnGenerate = get('modeGenerate');
                    
                    const panelAnalysis = get('analysis-panel');
                    const panelGeneration = get('generation-panel');
                    
                    const setActive = (btn) => {
                        [btnAnalysis, btnGenerate].forEach(b => {
                            if (b) {
                                b.classList.remove('active', 'bg-sky-600', 'border-sky-600', 'bg-emerald-600', 'border-emerald-600', 'text-white');
                                b.classList.add('bg-slate-700', 'border-slate-700', 'text-slate-300');
                            }
                        });
                        if (btn) {
                            btn.classList.remove('bg-slate-700', 'border-slate-700', 'text-slate-300');
                            btn.classList.add('active', 'text-white');
                            if (btn === btnAnalysis) btn.classList.add('bg-sky-600', 'border-sky-600');
                            if (btn === btnGenerate) btn.classList.add('bg-emerald-600', 'border-emerald-600');
                        }
                    };

                    if (btnAnalysis) {
                        btnAnalysis.addEventListener('click', (e) => {
                            if(e) e.preventDefault();
                            if (panelAnalysis) panelAnalysis.classList.remove('hidden');
                            if (panelGeneration) panelGeneration.classList.add('hidden');
                            setActive(btnAnalysis);
                            
                            // Reset view
                            const originalSection = get('originalCodeSection');
                            if (originalSection) originalSection.style.display = 'block';
                            const codeDisplaySection = get('codeDisplaySection');
                            if (codeDisplaySection) {
                                codeDisplaySection.classList.remove('lg:grid-cols-1');
                                codeDisplaySection.classList.add('lg:grid-cols-2');
                                codeDisplaySection.classList.remove('hidden');
                            }
                        });
                    }

                    if (btnGenerate) {
                        btnGenerate.addEventListener('click', (e) => {
                            if(e) e.preventDefault();
                            if (panelAnalysis) panelAnalysis.classList.add('hidden');
                            if (panelGeneration) panelGeneration.classList.remove('hidden');
                            setActive(btnGenerate);
                            
                            // Reset view
                            const originalSection = get('originalCodeSection');
                            if (originalSection) originalSection.style.display = 'none';
                            const codeDisplaySection = get('codeDisplaySection');
                            if (codeDisplaySection) {
                                codeDisplaySection.classList.remove('lg:grid-cols-2');
                                codeDisplaySection.classList.add('lg:grid-cols-1');
                                codeDisplaySection.classList.remove('hidden');
                            }
                        });
                    }
                };
                setupModeButtons();

                // Advanced Features
                setClick('generateTestsBtn', async () => {
                    if (!window.downloadData) return showToast('Generate or analyze code first', 'warning');
                    const feedback = get('reviewFeedback');
                    if (feedback) feedback.innerHTML = '<p class="text-blue-400"><i class="fas fa-spinner animate-spin mr-2"></i>Generating tests...</p>';
                    try {
                        const res = await fetch('http://localhost:8000/api/generate-tests', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: window.downloadData.code, language: window.downloadData.language })
                        });
                        const data = await res.json();
                        if (feedback) feedback.innerHTML = `<h4 class="text-emerald-400 font-bold mb-2">Unit Tests</h4><pre class="bg-slate-800 p-3 rounded text-sm overflow-auto max-h-96"><code>${data.tests.replace(/</g, '&lt;')}</code></pre>`;
                    } catch (e) { showToast("Test generation failed", "error"); }
                });

                setClick('generateDocsBtn', async () => {
                    if (!window.downloadData) return showToast('Generate or analyze code first', 'warning');
                    const feedback = get('reviewFeedback');
                    if (feedback) feedback.innerHTML = '<p class="text-blue-400"><i class="fas fa-spinner animate-spin mr-2"></i>Generating docs...</p>';
                    try {
                        const res = await fetch('http://localhost:8000/api/generate-docs', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: window.downloadData.code, language: window.downloadData.language })
                        });
                        const data = await res.json();
                        if (feedback) feedback.innerHTML = `<h4 class="text-blue-400 font-bold mb-2">Documentation</h4><div class="bg-slate-800 p-3 rounded max-h-96 overflow-auto">${typeof marked !== 'undefined' ? marked.parse(data.documentation) : data.documentation}</div>`;
                    } catch (e) { showToast("Docs generation failed", "error"); }
                });

                setClick('securityScanBtn', async () => {
                    if (!window.downloadData) return showToast('Generate or analyze code first', 'warning');
                    const feedback = get('reviewFeedback');
                    if (feedback) feedback.innerHTML = '<p class="text-yellow-400"><i class="fas fa-spinner animate-spin mr-2"></i>Scanning...</p>';
                    try {
                        const res = await fetch('http://localhost:8000/api/security-scan', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: window.downloadData.code, language: window.downloadData.language })
                        });
                        const data = await res.json();
                        if (feedback) feedback.innerHTML = `<h4 class="text-red-400 font-bold mb-2">Security Analysis</h4><div class="bg-slate-800 p-3 rounded max-h-96 overflow-auto whitespace-pre-wrap text-sm">${data.security_analysis.replace(/</g, '&lt;')}</div>`;
                    } catch (e) { showToast("Security scan failed", "error"); }
                });

                setClick('refactorSuggestionsBtn', async () => {
                    if (!window.downloadData) return showToast('Generate or analyze code first', 'warning');
                    const feedback = get('reviewFeedback');
                    if (feedback) feedback.innerHTML = '<p class="text-purple-400"><i class="fas fa-spinner animate-spin mr-2"></i>Analyzing...</p>';
                    try {
                        const res = await fetch('http://localhost:8000/api/refactor-suggestions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: window.downloadData.code, language: window.downloadData.language })
                        });
                        const data = await res.json();
                        if (feedback) feedback.innerHTML = `<h4 class="text-purple-400 font-bold mb-2">Refactoring Suggestions</h4><div class="bg-slate-800 p-3 rounded max-h-96 overflow-auto">${typeof marked !== 'undefined' ? marked.parse(data.refactoring_suggestions) : data.refactoring_suggestions}</div>`;
                    } catch (e) { showToast("Analysis failed", "error"); }
                });

                setClick('saveSnippetBtn', () => {
                    if (!window.downloadData) return showToast('Generate or analyze code first', 'warning');
                    const title = prompt('Snippet title:', 'My Code Snippet');
                    if (!title) return;
                    
                    fetch('http://localhost:8000/api/snippets/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: userType, title, code: window.downloadData.code, language: window.downloadData.language })
                    }).then(res => res.json()).then(data => {
                        showToast(`âœ… Snippet saved as #${data.snippet_id}`, 'success');
                    }).catch(err => showToast("Save failed", "error"));
                });

                setClick('viewHistoryBtn', async () => {
                    const feedback = get('reviewFeedback');
                    try {
                        const res = await fetch(`http://localhost:8000/api/history/${userType}`);
                        const data = await res.json();
                        if (data.history.length === 0) {
                            if (feedback) feedback.innerHTML = '<p class="text-slate-400">No version history yet.</p>';
                            return;
                        }
                        let html = `<h4 class="text-cyan-400 font-bold mb-2">Code History (${data.total_versions} versions)</h4>`;
                        data.history.forEach(v => {
                            html += `<div class="bg-slate-700 p-2 rounded mb-2"><p class="text-sm text-cyan-300">Version ${v.version} - ${v.action} (${new Date(v.timestamp).toLocaleString()})</p></div>`;
                        });
                        if (feedback) feedback.innerHTML = html;
                    } catch (e) { showToast("History fetch failed", "error"); }
                });

                // Diff View
                setClick('toggleDiffBtn', () => {
                    const codeSection = get('codeDisplaySection');
                    const diffContainer = get('diffViewContainer');
                    
                    if (diffContainer && diffContainer.classList.contains('hidden')) {
                        if (!window.downloadData || !window.downloadData.originalCode) return showToast('No code to diff', 'warning');
                        
                        if (typeof Diff !== 'undefined' && typeof Diff2HtmlUI !== 'undefined') {
                            const diffStr = Diff.createTwoFilesPatch("Original", "Rewritten", window.downloadData.originalCode, window.downloadData.code);
                            const ui = new Diff2HtmlUI(diffContainer, diffStr, {
                                drawFileList: false,
                                matching: 'lines',
                                outputFormat: 'side-by-side'
                            });
                            
                            if (codeSection) codeSection.classList.add('hidden');
                            diffContainer.classList.remove('hidden');
                            ui.draw();
                        } else {
                            showToast("Diff library not loaded", "error");
                        }
                    } else {
                        if (codeSection) codeSection.classList.remove('hidden');
                        if (diffContainer) diffContainer.classList.add('hidden');
                    }
                });

                // Theme Toggle
                const themeToggle = get('theme-toggle');
                if (themeToggle) {
                    const savedTheme = localStorage.getItem('theme') || 'dark';
                    document.body.classList.toggle('light-mode', savedTheme === 'light');
                    themeToggle.innerHTML = savedTheme === 'light' ? '<i class="fas fa-sun text-yellow-500"></i>' : '<i class="fas fa-moon text-yellow-400"></i>';
                    
                    themeToggle.onclick = () => {
                        const isLight = document.body.classList.toggle('light-mode');
                        localStorage.setItem('theme', isLight ? 'light' : 'dark');
                        themeToggle.innerHTML = isLight ? '<i class="fas fa-sun text-yellow-500"></i>' : '<i class="fas fa-moon text-yellow-400"></i>';
                        showToast(`Switched to ${isLight ? 'Light' : 'Dark'} mode`, 'success');
                    };
                }

                // Search
                const searchBox = get('search-results');
                if (searchBox) {
                    searchBox.oninput = () => {
                        const query = searchBox.value.toLowerCase();
                        const feedback = get('reviewFeedback');
                        if (!feedback) return;
                        
                        if (!query) {
                            feedback.classList.remove('search-highlight');
                            return;
                        }
                        
                        if (feedback.innerText.toLowerCase().includes(query)) {
                            feedback.classList.add('search-highlight');
                        } else {
                            feedback.classList.remove('search-highlight');
                        }
                    };
                }

                // Drag & Drop
                const setupDragDrop = () => {
                    const dropZone = document.querySelector('.dropzone');
                    if (!dropZone) return;
                    
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        dropZone.addEventListener(eventName, (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                        });
                    });
                    
                    ['dragenter', 'dragover'].forEach(eventName => {
                        dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
                    });
                    
                    ['dragleave', 'drop'].forEach(eventName => {
                        dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
                    });
                    
                    dropZone.addEventListener('drop', (e) => {
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            const file = files[0];
                            if (file.type.startsWith('text') || file.name.endsWith('.py') || file.name.endsWith('.js') || file.name.endsWith('.java') || file.name.endsWith('.cpp')) {
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    dropZone.value = event.target.result;
                                    showToast(`âœ… File uploaded: ${file.name}`, 'success');
                                };
                                reader.readAsText(file);
                            } else {
                                showToast('âŒ Please drop valid code files', 'error');
                            }
                        }
                    });
                };
                setupDragDrop();

                // Keyboard Shortcuts
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        const btn = get('reviewBtn');
                        if (btn) btn.click();
                    } else if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
                        e.preventDefault();
                        const btn = get('generateBtn');
                        if (btn) btn.click();
                    } else if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        const search = get('search-results');
                        if (search) {
                            search.classList.toggle('hidden');
                            if (!search.classList.contains('hidden')) search.focus();
                        }
                    }
                });

                // Tooltips
                const rBtn = get('reviewBtn');
                if (rBtn) rBtn.title = "Run Review (Ctrl+Enter)";
                const gBtn = get('generateBtn');
                if (gBtn) gBtn.title = "Generate Code (Ctrl+G)";

                console.log("âœ… Code Refine: Initialization Complete");

            } catch (criticalError) {
                console.error("CRITICAL INIT ERROR:", criticalError);
                alert("Application failed to initialize. Check console for details.");
            }
        };

        // Run Init
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>